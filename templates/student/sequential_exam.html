{% extends 'student/studentbase.html' %}
{% block content %}
{%load static%}

<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #1e40af;
      --accent-color: #3b82f6;
      --warning-color: #ef4444;
      --success-color: #22c55e;
      --bg-color: #f8fafc;
      --text-color: #1e293b;
      --timer-bg: #dbeafe;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    
    .exam-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .question-container {
      display: none;
      padding: 30px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
      border-left: 5px solid var(--accent-color);
    }
    
    .active-question {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .timer-card {
      background-color: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      margin-bottom: 30px;
    }
    
    .timer-header {
      background-color: var(--primary-color);
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 500;
    }
    
    .timer-body {
      display: flex;
      padding: 0;
    }
    
    .timer-column {
      flex: 1;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    .timer-column:first-child {
      background-color: var(--timer-bg);
    }
    
    .timer-column:not(:last-child)::after {
      content: '';
      position: absolute;
      right: 0;
      top: 20%;
      height: 60%;
      width: 1px;
      background-color: #e5e7eb;
    }
    
    .timer-label {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      color: #64748b;
    }
    
    .timer-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-color);
    }
    
    .timer-warning {
      color: var(--warning-color);
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    
    .progress-indicator {
      margin: 30px 0;
    }
    
    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 500;
      color: #64748b;
    }
    
    .progress {
      height: 8px;
      border-radius: 4px;
      background-color: #e2e8f0;
    }
    
    .progress-bar {
      background-color: var(--primary-color);
      border-radius: 4px;
      transition: width 0.5s ease-in-out;
    }
    
    .question-title {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .question-marks {
      display: inline-block;
      background-color: #f1f5f9;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 14px;
      color: #64748b;
      margin-left: 10px;
      vertical-align: middle;
    }
    
    .option-container {
      margin-bottom: 15px;
      background-color: #f8fafc;
      border-radius: 8px;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }
    
    .option-container:hover {
      background-color: #f1f5f9;
    }
    
    .form-check {
      padding: 15px 45px;
      margin: 0;
      cursor: pointer;
    }
    
    .form-check-input {
      margin-left: -25px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .form-check-input:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .form-check-input:checked ~ .form-check-label {
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .form-check-input:checked ~ .option-container {
      border-color: var(--primary-color);
      background-color: #eff6ff;
    }
    
    .form-check-label {
      font-weight: 500;
      cursor: pointer;
    }
    
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .btn-prev {
      background-color: #e2e8f0;
      color: #475569;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .btn-prev:hover:not(:disabled) {
      background-color: #cbd5e1;
    }
    
    .btn-next {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .btn-next:hover {
      background-color: var(--secondary-color);
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #16a34a;
    }
    
    /* Disable text selection */
    body.secure-exam {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* Sticky footer with finish button */
    .exam-footer {
      position: fixed;
      bottom: 0;
      right: 0;
      left: 0;
      padding: 15px 25px;
      background-color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.05);
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .finish-exam-btn {
      background-color: var(--warning-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .finish-exam-btn:hover {
      background-color: #dc2626;
      transform: translateY(-2px);
    }

    .exam-progress-status {
      background-color: #f1f5f9;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      color: #475569;
    }
    
    .course-title {
      text-align: center;
      margin-bottom: 30px;
      color: var(--primary-color);
      font-weight: 700;
    }
    
    /* Modal styling */
    .modal-content {
      border-radius: 12px;
      border: none;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      background-color: #f8fafc;
      border-radius: 12px 12px 0 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-title {
      font-weight: 600;
      color: var(--text-color);
    }
    
    .modal-footer {
      border-top: 1px solid #e5e7eb;
      padding: 15px;
    }
    
    .btn-modal-cancel {
      background-color: #e2e8f0;
      color: #475569;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
    }
    
    .btn-modal-submit {
      background-color: var(--warning-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .timer-body {
        flex-direction: column;
      }
      
      .timer-column:not(:last-child)::after {
        display: none;
      }
      
      .timer-value {
        font-size: 24px;
      }
      
      .option-container {
        margin-bottom: 10px;
      }
      
      .form-check {
        padding: 12px 40px;
      }
    }
  </style>
</head>

<div class="exam-container">
  <div class="timer-card">
    <div class="timer-header">
      Exam Timer
    </div>
    <div class="timer-body">
      <div class="timer-column">
        <div class="timer-label">
          <i class="fas fa-clock me-1"></i> Total Time Remaining
        </div>
        <div id="exam-timer" class="timer-value">Loading...</div>
      </div>
      <div class="timer-column">
        <div class="timer-label">
          <i class="fas fa-hourglass-half me-1"></i> Current Question Time
        </div>
        <div id="question-timer" class="timer-value">Loading...</div>
      </div>
    </div>
  </div>

  <div class="progress-indicator">
    <div class="progress-text">
      <div>Question <span id="current-question-num">1</span> of <span id="total-questions">{{ questions|length }}</span></div>
      <div class="answered-status"><span id="answered-count">0</span>/<span id="total-count">{{ questions|length }}</span> answered</div>
    </div>
    <div class="progress">
      <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
    </div>
  </div>

  <h2 class="course-title">{{course.course_name}}</h2>

  <form id="exam-form" class="form" autocomplete="off" method="POST">
    {% csrf_token %}
    
    {% for q in questions %}
    <div class="question-container {% if forloop.first %}active-question{% endif %}" 
         id="question-{{q.id}}" 
         data-question-id="{{q.id}}" 
         data-question-index="{{forloop.counter0}}">
         
      <h3 class="question-title">
        {{ forloop.counter }}. {{q.question}}
        <span class="question-marks">[Marks {{q.marks}}]</span>
      </h3>
      
      <div class="options-list">
        <div class="option-container">
          <div class="form-check">
            <input class="form-check-input question-option" type="radio" 
                  name="question_{{q.id}}" 
                  id="option1-{{q.id}}" 
                  value="Option1"
                  data-question-id="{{q.id}}"
                  onclick="handleOptionSelect(this)">
            <label class="form-check-label" for="option1-{{q.id}}">
              {{q.option1}}
            </label>
          </div>
        </div>

        <div class="option-container">
          <div class="form-check">
            <input class="form-check-input question-option" type="radio" 
                  name="question_{{q.id}}" 
                  id="option2-{{q.id}}" 
                  value="Option2"
                  data-question-id="{{q.id}}"
                  onclick="handleOptionSelect(this)">
            <label class="form-check-label" for="option2-{{q.id}}">
              {{q.option2}}
            </label>
          </div>
        </div>

        <div class="option-container">
          <div class="form-check">
            <input class="form-check-input question-option" type="radio" 
                  name="question_{{q.id}}" 
                  id="option3-{{q.id}}" 
                  value="Option3"
                  data-question-id="{{q.id}}"
                  onclick="handleOptionSelect(this)">
            <label class="form-check-label" for="option3-{{q.id}}">
              {{q.option3}}
            </label>
          </div>
        </div>

        <div class="option-container">
          <div class="form-check">
            <input class="form-check-input question-option" type="radio" 
                  name="question_{{q.id}}" 
                  id="option4-{{q.id}}" 
                  value="Option4"
                  data-question-id="{{q.id}}"
                  onclick="handleOptionSelect(this)">
            <label class="form-check-label" for="option4-{{q.id}}">
              {{q.option4}}
            </label>
          </div>
        </div>
      </div>

      <div class="navigation-buttons">
        {% if course.allow_backtracking %}
        <button type="button" class="btn btn-prev" onclick="prevQuestion()" {% if forloop.first %}disabled{% endif %}>
          <i class="fas fa-arrow-left me-1"></i> Previous
        </button>
        {% else %}
        <div></div> <!-- Empty div to maintain flex spacing -->
        {% endif %}
        
        {% if forloop.last %}
        <button type="button" class="btn btn-success btn-next" onclick="finishExam()">
          Finish Exam <i class="fas fa-check ms-1"></i>
        </button>
        {% else %}
        <button type="button" class="btn btn-next" onclick="nextQuestion()">
          Next <i class="fas fa-arrow-right ms-1"></i>
        </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </form>
  
  <!-- Sticky Footer with Finish Button -->
  <div class="exam-footer">
    <div class="exam-progress-status">
      <i class="fas fa-check-circle me-1"></i> <span id="answered-count-footer">0</span>/<span id="total-count-footer">{{ questions|length }}</span> questions answered
    </div>
    <button type="button" class="finish-exam-btn" onclick="finishExam()">
      <i class="fas fa-paper-plane me-1"></i> Finish Exam
    </button>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmFinishModal" tabindex="-1" aria-labelledby="confirmFinishModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmFinishModalLabel">
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Submission
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="finishModalBody">
          Are you sure you want to finish the exam?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-modal-submit" onclick="submitExam()">
            <i class="fas fa-paper-plane me-1"></i> Yes, Submit Exam
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Exam configuration
  const totalQuestions = {{ questions|length }};
  const totalExamTime = {{ course.total_time_minutes }} * 60; // Convert minutes to seconds
  const timePerQuestion = Math.floor(totalExamTime / totalQuestions);
  const securityLevel = "{{ course.security_level }}";
  const allowBacktracking = {% if course.allow_backtracking %}true{% else %}false{% endif %};
  
  // Variables for tracking the exam state
  let currentQuestionIndex = 0;
  let examTimeRemaining = totalExamTime;
  let questionTimeRemaining = timePerQuestion;
  let examTimerInterval;
  let questionTimerInterval;
  let answers = {};
  let questionTimings = {};
  let examStartTime = Date.now();
  
  // Initialize the exam
  document.addEventListener("DOMContentLoaded", function() {
    applySecurity();
    startExamTimer();
    startQuestionTimer();
    updateProgressBar();
    
    // Initialize the question timings
    const questions = document.querySelectorAll('.question-container');
    questions.forEach(question => {
      const questionId = question.dataset.questionId;
      questionTimings[questionId] = {
        startTime: null,
        totalTime: 0,
        endTime: null
      };
    });
    
    // Set start time for the first question
    if (questions.length > 0) {
      const firstQuestionId = questions[0].dataset.questionId;
      questionTimings[firstQuestionId].startTime = Date.now();
    }
    
    // Check for previously answered questions from cookies
    loadSavedAnswers();
    updateAnsweredCount();
    
    // Ensure the bootstrap modal is properly initialized
    const confirmFinishModal = document.getElementById('confirmFinishModal');
    if (confirmFinishModal && typeof bootstrap !== 'undefined') {
      // Create global modal instance for finish confirmation
      window.finishModal = new bootstrap.Modal(confirmFinishModal);
    }
    
    // Set total questions count in footer
    document.getElementById('total-count-footer').textContent = totalQuestions;
  });
  
  // Apply security measures based on the security level
  function applySecurity() {
    if (securityLevel >= 1) {
      // Disable right-click
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
      });
      
      // Disable sidebar navigation during exam
      const sidebar = document.querySelector('.sidebar');
      if (sidebar) {
        sidebar.classList.add('disabled-sidebar');
        sidebar.style.pointerEvents = 'none';
        sidebar.style.opacity = '0.5';
      }
      
      // Disable keyboard shortcuts that might help cheating
      document.addEventListener('keydown', function(e) {
        // Prevent view source, find, etc.
        if (
          (e.ctrlKey && (e.key === 'u' || e.key === 'c' || e.key === 'v' || e.key === 'f')) || 
          e.key === 'F12' || 
          (e.altKey && e.key === 'Tab')
        ) {
          e.preventDefault();
          return false;
        }
      });
    }
  }
  
  // Start the overall exam timer
  function startExamTimer() {
    updateExamTimerDisplay();
    
    examTimerInterval = setInterval(function() {
      examTimeRemaining--;
      updateExamTimerDisplay();
      
      if (examTimeRemaining <= 0) {
        clearInterval(examTimerInterval);
        autoSubmitExam();
      }
    }, 1000);
  }
  
  // Update the exam timer display
  function updateExamTimerDisplay() {
    const minutes = Math.floor(examTimeRemaining / 60);
    const seconds = examTimeRemaining % 60;
    const timerElement = document.getElementById('exam-timer');
    
    timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    
    // Add warning class if less than 10% of time remaining
    if (examTimeRemaining < totalExamTime * 0.1) {
      timerElement.classList.add('timer-warning');
    }
  }
  
  // Start the question timer
  function startQuestionTimer() {
    updateQuestionTimerDisplay();
    
    questionTimerInterval = setInterval(function() {
      questionTimeRemaining--;
      updateQuestionTimerDisplay();
      
      if (questionTimeRemaining <= 0) {
        clearInterval(questionTimerInterval);
        handleQuestionTimeout();
      }
    }, 1000);
  }
  
  // Update the question timer display
  function updateQuestionTimerDisplay() {
    const minutes = Math.floor(questionTimeRemaining / 60);
    const seconds = questionTimeRemaining % 60;
    const timerElement = document.getElementById('question-timer');
    
    timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    
    // Add warning class if less than 10 seconds remaining
    if (questionTimeRemaining <= 10) {
      timerElement.classList.add('timer-warning');
    } else {
      timerElement.classList.remove('timer-warning');
    }
  }
  
  // Handle a question timeout
  function handleQuestionTimeout() {
    // Record timing data for the current question
    const currentQuestion = document.querySelector('.question-container.active-question');
    const questionId = currentQuestion.dataset.questionId;
    
    questionTimings[questionId].endTime = Date.now();
    questionTimings[questionId].totalTime = timePerQuestion;
    
    // Move to the next question automatically
    if (currentQuestionIndex < totalQuestions - 1) {
      nextQuestion();
    } else {
      finishExam();
    }
  }
  
  // Move to the next question
  function nextQuestion() {
    // Save the current question's state
    const currentQuestion = document.querySelector('.question-container.active-question');
    const questionId = currentQuestion.dataset.questionId;
    
    // Record timing data
    questionTimings[questionId].endTime = Date.now();
    questionTimings[questionId].totalTime = timePerQuestion - questionTimeRemaining;
    
    // Hide current question
    currentQuestion.classList.remove('active-question');
    
    // Move to the next question
    currentQuestionIndex++;
    
    // Show the next question
    const nextQuestionElement = document.querySelector(`.question-container[data-question-index="${currentQuestionIndex}"]`);
    nextQuestionElement.classList.add('active-question');
    
    // Update current question number display
    document.getElementById('current-question-num').textContent = currentQuestionIndex + 1;
    
    // Reset and start the question timer
    questionTimeRemaining = timePerQuestion;
    clearInterval(questionTimerInterval);
    startQuestionTimer();
    
    // Start timing for this question
    const nextQuestionId = nextQuestionElement.dataset.questionId;
    questionTimings[nextQuestionId].startTime = Date.now();
    
    // Update progress bar
    updateProgressBar();
    
    // Disable the previous button on the first question
    if (allowBacktracking) {
      const prevButtons = document.querySelectorAll('.btn-prev');
      prevButtons.forEach(button => button.disabled = (currentQuestionIndex === 0));
    }
  }
  
  // Move to the previous question (if allowed)
  function prevQuestion() {
    if (!allowBacktracking || currentQuestionIndex === 0) return;
    
    // Save the current question's state
    const currentQuestion = document.querySelector('.question-container.active-question');
    const questionId = currentQuestion.dataset.questionId;
    
    // Record timing data
    questionTimings[questionId].endTime = Date.now();
    questionTimings[questionId].totalTime += timePerQuestion - questionTimeRemaining;
    
    // Hide current question
    currentQuestion.classList.remove('active-question');
    
    // Move to the previous question
    currentQuestionIndex--;
    
    // Show the previous question
    const prevQuestionElement = document.querySelector(`.question-container[data-question-index="${currentQuestionIndex}"]`);
    prevQuestionElement.classList.add('active-question');
    
    // Update current question number display
    document.getElementById('current-question-num').textContent = currentQuestionIndex + 1;
    
    // Reset and start the question timer
    questionTimeRemaining = timePerQuestion;
    clearInterval(questionTimerInterval);
    startQuestionTimer();
    
    // Continue timing for this question
    const prevQuestionId = prevQuestionElement.dataset.questionId;
    questionTimings[prevQuestionId].startTime = Date.now();
    
    // Update progress bar
    updateProgressBar();
    
    // Disable the previous button on the first question
    if (allowBacktracking) {
      const prevButtons = document.querySelectorAll('.btn-prev');
      prevButtons.forEach(button => button.disabled = (currentQuestionIndex === 0));
    }
  }
  
  // Handle option selection
  function handleOptionSelect(element) {
    const questionId = element.dataset.questionId;
    const value = element.value;
    
    // Store the selected answer
    answers[questionId] = value;
    
    // Save to cookie for backup
    setCookie(`question_${questionId}`, value, 1);
    
    // Highlight the selected option's container
    const optionContainers = document.querySelectorAll(`.question-container[data-question-id="${questionId}"] .option-container`);
    optionContainers.forEach(container => {
      container.style.borderColor = 'transparent';
      container.style.backgroundColor = '#f8fafc';
    });
    
    // Highlight the selected option
    const selectedContainer = element.closest('.option-container');
    if (selectedContainer) {
      selectedContainer.style.borderColor = 'var(--primary-color)';
      selectedContainer.style.backgroundColor = '#eff6ff';
    }
    
    // Update answered questions count
    updateAnsweredCount();
  }
  
  // Update the count of answered questions
  function updateAnsweredCount() {
    const answeredCount = Object.keys(answers).length;
    document.getElementById('answered-count').textContent = answeredCount;
    document.getElementById('answered-count-footer').textContent = answeredCount;
    
    // Update progress color based on completion
    const progressBar = document.getElementById('progress-bar');
    const completionRatio = answeredCount / totalQuestions;
    
    if (completionRatio === 1) {
      progressBar.classList.add('bg-success');
    } else {
      progressBar.classList.remove('bg-success');
    }
  }
  
  // Update the progress bar
  function updateProgressBar() {
    const progressPercent = ((currentQuestionIndex + 1) / totalQuestions) * 100;
    document.getElementById('progress-bar').style.width = `${progressPercent}%`;
  }
  
  // Show the finish confirmation modal
  function finishExam() {
    // Get total questions and count answered questions
    const totalQuestions = document.querySelectorAll('.question-container').length;
    const answeredQuestions = Object.keys(answers).length;
    const unansweredCount = totalQuestions - answeredQuestions;
    
    if (unansweredCount > 0) {
      // Create warning message
      let warningMessage = `<div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Warning:</strong> You have ${unansweredCount} unanswered question${unansweredCount > 1 ? 's' : ''}.
        <br>Unanswered questions will be marked as incorrect.
      </div>`;
      
      // Set the warning message in the modal
      document.getElementById('finishModalBody').innerHTML = warningMessage;
    } else {
      // Confirmation message if all questions are answered
      document.getElementById('finishModalBody').innerHTML = `
        <div class="alert alert-success">
          <i class="fas fa-check-circle me-2"></i>
          <strong>Great job!</strong> You've answered all questions.
          <br>Are you ready to submit your exam?
        </div>`;
    }
    
    // Show the finish confirmation modal
    if (window.finishModal) {
      window.finishModal.show();
    } else {
      // Fallback if modal object wasn't created during initialization
      const confirmFinishModal = document.getElementById('confirmFinishModal');
      if (confirmFinishModal && typeof bootstrap !== 'undefined') {
        new bootstrap.Modal(confirmFinishModal).show();
      } else {
        // Direct submit if modal isn't available
        if (confirm('Are you sure you want to finish the exam?')) {
          submitExam();
        }
      }
    }
  }
  
  // Submit the exam
  function submitExam() {
    // Stop the timers
    clearInterval(examTimerInterval);
    clearInterval(questionTimerInterval);
    
    // Enable sidebar before leaving
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      sidebar.classList.remove('disabled-sidebar');
      sidebar.style.pointerEvents = 'auto';
      sidebar.style.opacity = '1';
    }
    
    // Save the current question's state
    const currentQuestion = document.querySelector('.question-container.active-question');
    if (currentQuestion) {
      const questionId = currentQuestion.dataset.questionId;
      questionTimings[questionId].endTime = Date.now();
      questionTimings[questionId].totalTime += timePerQuestion - questionTimeRemaining;
    }
    
    // Calculate the total time taken
    const totalTimeTaken = totalExamTime - examTimeRemaining;
    
    // Save all timing data
    for (const questionId in questionTimings) {
      // Skip if no start time (question was never shown)
      if (!questionTimings[questionId].startTime) continue;
      
      // For questions without an endTime (never completed), set the end time now
      if (!questionTimings[questionId].endTime) {
        questionTimings[questionId].endTime = Date.now();
        questionTimings[questionId].totalTime = Math.min(
          Math.floor((questionTimings[questionId].endTime - questionTimings[questionId].startTime) / 1000),
          timePerQuestion
        );
      }
      
      // Save to cookies
      setCookie(`q_${questionId}_final_time`, questionTimings[questionId].totalTime, 1);
    }
    
    // Save the total exam time
    setCookie("exam_total_time", totalTimeTaken, 1);
    
    // Save all answers to cookies for the calculate-marks endpoint
    const questions = document.querySelectorAll('.question-container');
    questions.forEach((question, index) => {
      const questionId = question.dataset.questionId;
      const answer = answers[questionId];
      
      if (answer) {
        setCookie(index + 1, answer, 1); // Legacy format for calculate-marks
      }
    });
    
    // Show loading overlay
    const loadingOverlay = document.createElement('div');
    loadingOverlay.style.position = 'fixed';
    loadingOverlay.style.top = '0';
    loadingOverlay.style.left = '0';
    loadingOverlay.style.width = '100%';
    loadingOverlay.style.height = '100%';
    loadingOverlay.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
    loadingOverlay.style.display = 'flex';
    loadingOverlay.style.alignItems = 'center';
    loadingOverlay.style.justifyContent = 'center';
    loadingOverlay.style.zIndex = '9999';
    loadingOverlay.innerHTML = `
      <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <h4>Submitting your exam...</h4>
      </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    // Redirect to calculate-marks
    setTimeout(() => {
      window.location.href = '/student/calculate-marks';
    }, 800);
  }
  
  // Auto-submit the exam when the total time expires
  function autoSubmitExam() {
    alert("Time's up! Your exam will be submitted automatically.");
    submitExam();
  }
  
  // Set a cookie
  function setCookie(cname, cvalue, exdays) {
    const d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    const expires = "expires=" + d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  }
  
  // Load any previously saved answers from cookies
  function loadSavedAnswers() {
    const questions = document.querySelectorAll('.question-container');
    questions.forEach(question => {
      const questionId = question.dataset.questionId;
      const savedAnswer = getCookie(`question_${questionId}`);
      
      if (savedAnswer) {
        // Mark as answered in our tracking
        answers[questionId] = savedAnswer;
        
        // Select the correct radio button
        const radioInput = document.querySelector(`input[name="question_${questionId}"][value="${savedAnswer}"]`);
        if (radioInput) {
          radioInput.checked = true;
          
          // Highlight the selected option
          const selectedContainer = radioInput.closest('.option-container');
          if (selectedContainer) {
            selectedContainer.style.borderColor = 'var(--primary-color)';
            selectedContainer.style.backgroundColor = '#eff6ff';
          }
        }
      }
    });
  }
  
  // Get cookie value
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
</script>

<br><br><br><br><br><br>
{% endblock content %} 