{% extends 'student/studentbase.html' %}
{% block content %}
{%load static%}

<head>
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
  <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
</head>

<div class="jumbotron my-4">
  <form class="form" autocomplete="off" onsubmit="return saveAns()" action="/student/calculate-marks" method="POST">
    {% csrf_token %}
    <h1 style="text-align: center;">{{course.course_name}}</h1>
    {% for q in questions%}
    <div class="question-container" id="question-{{q.id}}" data-question-id="{{q.id}}">
      <h3 class="text-info">{{ forloop.counter }}. {{q.question}}</h3><h4 style="text-align: right;">[Marks {{q.marks}}]</h4>
      
      {% if q.question_type == 'multiple_choice' %}
        <div class="form-check mx-4">
          <input class="form-check-input question-option" type="radio" 
                name="{{ forloop.counter }}" 
                id="option1-{{q.id}}" 
                value="Option1"
                data-question-id="{{q.id}}"
                onclick="trackSelection(this)">
          <label class="form-check-label" for="option1-{{q.id}}">
            {{q.option1}}
          </label>
        </div>

        <div class="form-check mx-4">
          <input class="form-check-input question-option" type="radio" 
                name="{{ forloop.counter }}" 
                id="option2-{{q.id}}" 
                value="Option2"
                data-question-id="{{q.id}}"
                onclick="trackSelection(this)">
          <label class="form-check-label" for="option2-{{q.id}}">
            {{q.option2}}
          </label>
        </div>

        <div class="form-check mx-4">
          <input class="form-check-input question-option" type="radio" 
                name="{{ forloop.counter }}" 
                id="option3-{{q.id}}" 
                value="Option3"
                data-question-id="{{q.id}}"
                onclick="trackSelection(this)">
          <label class="form-check-label" for="option3-{{q.id}}">
            {{q.option3}}
          </label>
        </div>

        <div class="form-check mx-4">
          <input class="form-check-input question-option" type="radio" 
                name="{{ forloop.counter }}" 
                id="option4-{{q.id}}" 
                value="Option4"
                data-question-id="{{q.id}}"
                onclick="trackSelection(this)">
          <label class="form-check-label" for="option4-{{q.id}}">
            {{q.option4}}
          </label>
        </div>
      
      {% elif q.question_type == 'checkbox' %}
        <div class="form-check mx-4">
          <input class="form-check-input question-checkbox" type="checkbox" 
                name="{{ forloop.counter }}_Option1" 
                id="option1-{{q.id}}" 
                value="Option1"
                data-question-id="{{q.id}}"
                onclick="trackCheckboxSelection(this)">
          <label class="form-check-label" for="option1-{{q.id}}">
            {{q.option1}}
          </label>
        </div>

        <div class="form-check mx-4">
          <input class="form-check-input question-checkbox" type="checkbox" 
                name="{{ forloop.counter }}_Option2" 
                id="option2-{{q.id}}" 
                value="Option2"
                data-question-id="{{q.id}}"
                onclick="trackCheckboxSelection(this)">
          <label class="form-check-label" for="option2-{{q.id}}">
            {{q.option2}}
          </label>
        </div>

        <div class="form-check mx-4">
          <input class="form-check-input question-checkbox" type="checkbox" 
                name="{{ forloop.counter }}_Option3" 
                id="option3-{{q.id}}" 
                value="Option3"
                data-question-id="{{q.id}}"
                onclick="trackCheckboxSelection(this)">
          <label class="form-check-label" for="option3-{{q.id}}">
            {{q.option3}}
          </label>
        </div>

        <div class="form-check mx-4">
          <input class="form-check-input question-checkbox" type="checkbox" 
                name="{{ forloop.counter }}_Option4" 
                id="option4-{{q.id}}" 
                value="Option4"
                data-question-id="{{q.id}}"
                onclick="trackCheckboxSelection(this)">
          <label class="form-check-label" for="option4-{{q.id}}">
            {{q.option4}}
          </label>
        </div>
      
      {% elif q.question_type == 'short_answer' %}
        <div class="form-group mx-4">
          <textarea class="form-control question-short-answer" 
                  name="{{ forloop.counter }}" 
                  id="short-answer-{{q.id}}" 
                  rows="3"
                  data-question-id="{{q.id}}"
                  oninput="trackShortAnswerInput(this)"></textarea>
        </div>
      {% endif %}
    </div>
    {% endfor %}
    <input class="btn btn-info btn-lg" type="submit" value="Submit">  
  </form>
</div>

<script> 
  // Initialize variables to track timing
  let startTime = Date.now();
  let questionTimings = {};
  let questionSelections = {};
  let currentFocusedQuestion = null;
  let lastInteractionTime = Date.now();
  let checkboxSelections = {};
  
  // Initialize timing for all questions
  document.addEventListener("DOMContentLoaded", function () {
    // Setup timers for each question
    let questions = document.querySelectorAll('.question-container');
    questions.forEach(function(question) {
      let questionId = question.dataset.questionId;
      questionTimings[questionId] = {
        time: 0,
        firstInteraction: null,
        lastInteraction: null
      };
      questionSelections[questionId] = null;
      checkboxSelections[questionId] = [];
    });
    
    // Set the first question as focused
    if (questions.length > 0) {
      currentFocusedQuestion = questions[0].dataset.questionId;
    }
    
    // Start tracking with periodic updates
    setInterval(updateTimings, 1000); // Update every second
    
    // Track when user scrolls to different questions
    window.addEventListener('scroll', function() {
      updateCurrentQuestion();
      lastInteractionTime = Date.now();
    });
    
    // Track user activity
    document.addEventListener('mousemove', function() {
      lastInteractionTime = Date.now();
    });
    
    document.addEventListener('keypress', function() {
      lastInteractionTime = Date.now();
    });
    
    let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]");
    if (csrfToken) {
      console.log("CSRF Token Found: ", csrfToken.value);
    } else {
      console.log("CSRF Token Missing!");
    }
  });
  
  // Track which question the user is currently focused on
  function updateCurrentQuestion() {
    let questions = document.querySelectorAll('.question-container');
    let windowMiddle = window.scrollY + (window.innerHeight / 2);
    
    // Find the question closest to the middle of the viewport
    let closestQuestion = null;
    let closestDistance = Infinity;
    
    questions.forEach(function(question) {
      let rect = question.getBoundingClientRect();
      let questionMiddle = rect.top + (rect.height / 2);
      let distance = Math.abs(questionMiddle);
      
      if (distance < closestDistance) {
        closestDistance = distance;
        closestQuestion = question;
      }
    });
    
    if (closestQuestion) {
      currentFocusedQuestion = closestQuestion.dataset.questionId;
    }
  }
  
  // Update the timing data
  function updateTimings() {
    // Only update if user is active (within last 30 seconds)
    if (Date.now() - lastInteractionTime < 30000 && currentFocusedQuestion) {
      let timing = questionTimings[currentFocusedQuestion];
      timing.time += 1; // Increment by 1 second
      
      if (!timing.firstInteraction) {
        timing.firstInteraction = Date.now();
      }
      timing.lastInteraction = Date.now();
    }
  }
  
  // Track when a radio option is selected
  function trackSelection(element) {
    let questionId = element.dataset.questionId;
    questionSelections[questionId] = element.value;
    
    // Update timing data
    lastInteractionTime = Date.now();
    let timing = questionTimings[questionId];
    timing.lastInteraction = Date.now();
    
    // Save the selection and timing
    setCookie("q_" + questionId + "_selection", element.value, 1);
    setCookie("q_" + questionId + "_time", timing.time, 1);
  }
  
  // Track checkbox selections
  function trackCheckboxSelection(element) {
    let questionId = element.dataset.questionId;
    let value = element.value;
    let index = checkboxSelections[questionId].indexOf(value);
    
    // Add or remove the selection based on checkbox state
    if (element.checked && index === -1) {
      checkboxSelections[questionId].push(value);
    } else if (!element.checked && index !== -1) {
      checkboxSelections[questionId].splice(index, 1);
    }
    
    // Update timing data
    lastInteractionTime = Date.now();
    let timing = questionTimings[questionId];
    timing.lastInteraction = Date.now();
    
    // Save the selection as JSON and timing
    setCookie("q_" + questionId + "_checkbox_selection", JSON.stringify(checkboxSelections[questionId]), 1);
    setCookie("q_" + questionId + "_time", timing.time, 1);
  }
  
  // Track short answer input
  function trackShortAnswerInput(element) {
    let questionId = element.dataset.questionId;
    let value = element.value;
    
    // Update timing data
    lastInteractionTime = Date.now();
    let timing = questionTimings[questionId];
    timing.lastInteraction = Date.now();
    
    // Save the short answer text and timing
    setCookie("q_" + questionId + "_short_answer", value, 1);
    setCookie("q_" + questionId + "_time", timing.time, 1);
  }
  
  function saveAns() {  
    // Save the final timing data for all questions
    for (let questionId in questionTimings) {
      setCookie("q_" + questionId + "_final_time", questionTimings[questionId].time, 1);
    }
    
    // Save the total exam time
    let totalTime = Math.floor((Date.now() - startTime) / 1000);
    setCookie("exam_total_time", totalTime, 1);
    
    // Save answers for all question types
    var radioButtons = document.querySelectorAll('input[type="radio"]:checked');
    for (var i = 0; i < radioButtons.length; i++) {
      setCookie(radioButtons[i].name, radioButtons[i].value, 3);
    }
    
    // Save checkbox selections (multiple answers)
    for (let questionId in checkboxSelections) {
      if (checkboxSelections[questionId].length > 0) {
        setCookie("checkbox_" + questionId, JSON.stringify(checkboxSelections[questionId]), 3);
      }
    }
    
    // Save short answers
    var shortAnswers = document.querySelectorAll('.question-short-answer');
    for (var i = 0; i < shortAnswers.length; i++) {
      if (shortAnswers[i].value.trim() !== '') {
        setCookie(shortAnswers[i].name + "_short", shortAnswers[i].value, 3);
      }
    }
    
    return true;  // Allow the form to submit naturally
  }
  
  function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    var expires = "expires="+ d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
  }
</script> 

<br><br><br><br><br><br>
{% endblock content %}