{% extends 'teacher/teacherbase.html' %}
{% load widget_tweaks %}
{% block content %}

<div class="container py-5">
  <div class="card">
    <div class="card-header bg-c-blue text-white">
      <h4 class="mb-0">
        <i class="fas fa-robot mr-2"></i> AI-Powered Exam Generation
        <!-- AI Service Status Indicator -->
        <span class="ai-status-indicator float-end">
          <span class="badge bg-secondary" id="aiStatusBadge">
            <i class="fas fa-circle-notch fa-spin"></i> Checking AI Service...
          </span>
        </span>
      </h4>
    </div>
    <div class="card-body bg-c-purple">
      <div class="row mb-4">
        <div class="col-md-8">
          <p class="lead text-white">
            Generate multiple-choice questions automatically using AI technology. Upload course materials and customize the exam parameters to create exams tailored to your needs.
          </p>
        </div>
        <div class="col-md-4 text-center">
          <i class="fas fa-cogs fa-5x text-white"></i>
        </div>
      </div>

      <form method="post" enctype="multipart/form-data" id="examForm">
        {% csrf_token %}
        
        {% if error %}
        <div class="alert alert-danger">
          {{ error }}
        </div>
        {% endif %}

        <div class="form-group row">
          <div class="col-md-6 mb-3 text-white">
            <label for="{{ exam_form.course.id_for_label }}">
              <i class="fas fa-book mr-1"></i> {{ exam_form.course.label }}
            </label>
            {{ exam_form.course|add_class:"form-control text-black" }}
          </div>
          <div class="col-md-6 mb-3 text-white">
            <label for="{{ exam_form.title.id_for_label }}">
              <i class="fas fa-heading mr-1"></i> {{ exam_form.title.label }}
            </label>
            {{ exam_form.title|add_class:"form-control text-black" }}
          </div>
        </div>

        <div class="form-group mb-3 text-white">
          <label for="{{ exam_form.description.id_for_label }}">
            <i class="fas fa-align-left mr-1"></i> {{ exam_form.description.label }}
          </label>
          {{ exam_form.description|add_class:"form-control text-black" }}
        </div>

        <div class="form-group row">
          <div class="col-md-4 mb-3 text-white">
            <label for="{{ exam_form.difficulty.id_for_label }}">
              <i class="fas fa-chart-line mr-1"></i> {{ exam_form.difficulty.label }}
            </label>
            {{ exam_form.difficulty|add_class:"form-control text-black" }}
          </div>
          <div class="col-md-4 mb-3 text-white">
            <label for="{{ exam_form.num_questions.id_for_label }}">
              <i class="fas fa-list-ol mr-1"></i> {{ exam_form.num_questions.label }}
            </label>
            {{ exam_form.num_questions|add_class:"form-control text-black" }}
          </div>
          <div class="col-md-4 mb-3 text-white">
            <label for="{{ exam_form.time_limit.id_for_label }}">
              <i class="fas fa-clock mr-1"></i> {{ exam_form.time_limit.label }}
            </label>
            {{ exam_form.time_limit|add_class:"form-control text-black" }}
          </div>
        </div>

        <div class="form-group mb-4 text-white">
          <label for="{{ exam_form.reference_material.id_for_label }}">
            <i class="fas fa-file-upload mr-1"></i> {{ exam_form.reference_material.label }}
          </label>
          {{ exam_form.reference_material|add_class:"form-control-file" }}
          <small class="form-text text-white">{{ exam_form.reference_material.help_text }}</small>
        </div>

        <div class="alert alert-info">
          <i class="fas fa-info-circle mr-2"></i> 
          The AI will generate multiple-choice questions based on your selected parameters. You'll be able to review and edit the questions before finalizing the exam.
        </div>

        <div class="form-group text-center mt-4">
          <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
            <i class="fas fa-magic mr-2"></i> Generate Exam
          </button>
          <a href="{% url 'teacher-dashboard' %}" class="btn btn-secondary btn-lg ml-2">
            <i class="fas fa-arrow-left mr-2"></i> Back
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-backdrop="static" data-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-4">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="sr-only">Loading...</span>
        </div>
        <h4 class="text-primary">Generating Exam...</h4>
        <p class="text-muted">Please wait while the AI generates your exam questions.</p>
      </div>
    </div>
  </div>
</div>

<!-- Error Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-danger text-white">
      <i class="fas fa-exclamation-circle me-2"></i>
      <strong class="me-auto">Error</strong>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      <span id="errorMessage"></span>
    </div>
  </div>
</div>

<style>
    :root {
      --blue: #24b0ed;
      --indigo: #6610f2;
      --purple: #6f42c1;
      --pink: #e83e8c;
      --red: #dc3545;
      --darkblue: #000033;
      --orange: #fd7e14;
      --yellow: #ffc107;
      --green: #28a745;
      --teal: #20c997;
      --cyan: #17a2b8;
      --white: #fff;
      --gray: #6c757d;
      --gray-dark: #343a40;
      --primary: #24b0ed;
      --secondary: #6c757d;
      --success: #28a745;
      --info: #17a2b8;
      --warning: #ffc107;
      --danger: #dc3545;
      --light: #f8f9fa;
      --dark: #1e1e2d;
      --breakpoint-xs: 0;
      --breakpoint-sm: 576px;
      --breakpoint-md: 768px;
      --breakpoint-lg: 992px;
      --breakpoint-xl: 1200px;
      --font-family-sans-serif: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
      /* Cosmic Deep Blue (Nebula) */
.bg-c-blue {
  background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
}

/* Galactic Teal (Aurora) */
.bg-c-green {
  background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
}

/* Cyber Sunset (Neon Glow) */
.bg-c-yellow {
  background: linear-gradient(135deg, #3a1c71 0%, #d76d77 50%, #ffaf7b 100%);
}

/* Void Purple (Dark Matter) */
.bg-c-pink {
  background: linear-gradient(135deg, #4b1248 0%, #6b3074 50%, #a4508b 100%);
}

/* Stellar Purple (Space Dust) */
.bg-c-purple {
  background: linear-gradient(135deg, #1e0024 0%, #4e1d6d 50%, #a239ea 100%);
}
.cosmic-bg {
  position: relative;
  overflow: hidden;
}

/* Star particles */
.cosmic-bg::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(white 1px, transparent 1px),
    radial-gradient(white 1px, transparent 1px);
  background-size: 20px 20px;
  background-position: 0 0, 10px 10px;
  opacity: 0.2;
  animation: stars 50s linear infinite;
}

@keyframes stars {
  from { background-position: 0 0, 10px 10px; }
  to { background-position: 200px 200px, 210px 210px; }
}
  .toast {
    min-width: 300px;
  }
  .modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5);
  }
  .ai-status-indicator {
    display: inline-block;
    margin-left: 15px;
  }
  .badge {
    padding: 8px 12px;
    font-size: 0.9em;
  }
  .badge i {
    margin-right: 5px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('examForm');
    const generateBtn = document.getElementById('generateBtn');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    const errorToast = new bootstrap.Toast(document.getElementById('errorToast'));
    
    // Function to update AI service status
    function updateAIStatus() {
      fetch('/teacher/ai-status/')
        .then(response => response.json())
        .then(data => {
          const badge = document.getElementById('aiStatusBadge');
          if (data.connected) {
            badge.className = 'badge bg-success';
            badge.innerHTML = '<i class="fas fa-check-circle"></i> AI Service Connected';
            if (data.token_usage) {
              badge.innerHTML += ` (Tokens: ${data.token_usage.total_tokens || 'N/A'})`;
            }
            
            // Enable the form submit button
            generateBtn.disabled = false;
          } else {
            badge.className = 'badge bg-danger';
            badge.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${data.error || 'AI Service Unavailable'}`;
            
            // Disable the form submit button
            generateBtn.disabled = true;
          }
        })
        .catch(error => {
          const badge = document.getElementById('aiStatusBadge');
          badge.className = 'badge bg-danger';
          badge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to check status';
          
          // Disable the form submit button to be safe
          generateBtn.disabled = true;
        });
    }
    
    // Check status immediately and then every 30 seconds
    updateAIStatus();
    setInterval(updateAIStatus, 30000);
    
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Show loading modal
      loadingModal.show();
      
      // Disable submit button
      generateBtn.disabled = true;
      
      // Create FormData object
      const formData = new FormData(form);
      
      // Submit form via fetch
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Redirect to the review page
          window.location.href = data.redirect_url;
        } else {
          throw new Error(data.error || 'Failed to generate exam');
        }
      })
      .catch(error => {
        // Hide loading modal
        loadingModal.hide();
        
        // Enable submit button
        generateBtn.disabled = false;
        
        // Show error toast
        document.getElementById('errorMessage').textContent = error.message || 'An error occurred while generating the exam. Please try again.';
        errorToast.show();
      });
    });
  });
</script>

{% endblock content %} 