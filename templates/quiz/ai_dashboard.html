{% extends 'teacher/teacherbase.html' %}
{% load static %}

{% block title %}CUT AI Adoption Analytics Platform{% endblock %}

{% block custom_css %}
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: #2d3748;
    }
    
    .ai-dashboard-container {
        min-height: 85vh;
        margin-top: 20px;
    }
    
    .nav-pills .nav-link {
        color: #4a5568;
        font-weight: 500;
        padding: 12px 20px;
        border-radius: 8px;
        margin-right: 8px;
        display: flex;
        align-items: center;
    }
    
    .nav-pills .nav-link i {
        margin-right: 8px;
    }
    
    .nav-pills .nav-link.active {
        background-color: #4299e1;
        color: white;
    }
    
    .tab-content {
        margin-top: 20px;
    }
    
    .upload-container {
        background-color: #fff;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .upload-area {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        background-color: #f7fafc;
        margin: 20px 0;
        transition: all 0.3s;
    }
    
    .upload-area:hover {
        border-color: #3182ce;
        background-color: #ebf8ff;
    }
    
    .upload-icon {
        font-size: 40px;
        color: #a0aec0;
        margin-bottom: 15px;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #f7fafc;
        border-radius: 4px;
        margin-top: 10px;
    }
    
    .file-icon {
        color: #4299e1;
        font-size: 18px;
        margin-right: 10px;
    }
    
    .file-info {
        flex: 1;
    }
    
    .file-size {
        color: #718096;
        font-size: 12px;
    }
    
    .remove-file {
        color: #e53e3e;
        cursor: pointer;
    }
    
    .data-preview {
        background-color: #fff;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th, .data-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .data-table th {
        background-color: #f7fafc;
        font-weight: 500;
    }
    
    .status-message {
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .status-message.success {
        background-color: #c6f6d5;
        color: #276749;
    }
    
    .status-message.info {
        background-color: #bee3f8;
        color: #2c5282;
    }
    
    .stats-container {
        background-color: #fff;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .stats-grid {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }
    
    .stat-box {
        text-align: center;
        flex: 1;
        padding: 15px;
    }
    
    .stat-value {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #718096;
        font-size: 14px;
    }
    
    .chart-container {
        background-color: #fff;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .chart-tabs {
        display: flex;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 20px;
    }
    
    .chart-tab {
        padding: 10px 15px;
        margin-right: 5px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    
    .chart-tab.active {
        border-bottom-color: #3182ce;
        color: #3182ce;
        font-weight: 500;
    }
    
    .chart-area {
        height: 300px;
    }
    
    .btn-primary {
        background-color: #4299e1;
        border-color: #4299e1;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .btn-primary:hover {
        background-color: #3182ce;
        border-color: #3182ce;
    }
    
    .filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .filter-tag {
        background-color: #3182ce;
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        font-size: 14px;
    }
    
    .filter-tag i {
        margin-left: 8px;
        cursor: pointer;
    }
    
    .prediction-container {
        background-color: #fff;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .prediction-value {
        font-size: 36px;
        font-weight: 700;
        color: #3182ce;
    }
    
    .prediction-change {
        display: flex;
        align-items: center;
        color: #48bb78;
        font-weight: 500;
        margin-top: 5px;
    }
    
    .prediction-change.negative {
        color: #e53e3e;
    }
    
    .prediction-change i {
        margin-right: 5px;
    }
    
    .factors-chart {
        height: 200px;
        margin-top: 20px;
    }
    
    .loading-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3182ce;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .about-section {
        padding: 0 20px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">CUT AI Adoption Analytics Platform</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'teacher-dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">AI Adoption Analytics</li>
    </ol>
    
    <div class="ai-dashboard-container">
        <!-- Pill Navigation -->
        <ul class="nav nav-pills mb-4" id="aiTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="data-upload-tab" data-bs-toggle="pill" data-bs-target="#data-upload" type="button" role="tab">
                    <i class="fas fa-upload"></i> Data Upload
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-chart-bar"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="predictions-tab" data-bs-toggle="pill" data-bs-target="#predictions" type="button" role="tab">
                    <i class="fas fa-brain"></i> AI Predictions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="insights-tab" data-bs-toggle="pill" data-bs-target="#insights" type="button" role="tab">
                    <i class="fas fa-lightbulb"></i> Insights
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="admin-tab" data-bs-toggle="pill" data-bs-target="#admin" type="button" role="tab">
                    <i class="fas fa-cog"></i> Admin
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="aiTabsContent">
            <!-- Data Upload Tab -->
            <div class="tab-pane fade show active" id="data-upload" role="tabpanel" aria-labelledby="data-upload-tab">
                <h2>Upload Survey Data</h2>
                <p class="text-muted">Upload your CSV file containing the AI adoption survey responses.</p>
                
                <div class="upload-container">
                    <h5>Upload AI Training Data</h5>
                    <form id="uploadForm" enctype="multipart/form-data" action="{% url 'quiz:ajax_upload_csv' %}" method="post">
                        {% csrf_token %}
                        <div class="upload-area" id="drop-area" style="aspect-ratio: 1/1; max-width: 400px; margin: 0 auto; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt upload-icon" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <p class="mb-2">Drop CSV file here or click to browse</p>
                            <p class="text-muted small">Limit 200MB per file â€¢ CSV format only</p>
                            <input type="file" id="fileInput" name="csv_file" accept=".csv" style="display: none;">
                        </div>
                    </form>
                    
                    <div id="filePreview" style="display: none; max-width: 400px; margin: 20px auto 0;">
                        <div class="file-item">
                            <i class="fas fa-file-csv file-icon"></i>
                            <div class="file-info">
                                <div id="fileName">filename.csv</div>
                                <div class="file-size" id="fileSize">0 KB</div>
                            </div>
                            <i class="fas fa-times remove-file" id="removeFile"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Processing Indicator -->
                <div id="processingIndicator" class="loading-indicator" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span id="processingText">RUNNING...</span>
                    <button id="stopProcessingBtn" class="btn btn-outline-secondary btn-sm ms-3">Stop</button>
                </div>
                
                <!-- Data Preview Section (initially hidden) -->
                <div id="dataPreviewSection" style="display: none;">
                    <div class="data-preview">
                        <h4>Data Preview</h4>
                        <div class="table-responsive">
                            <table class="data-table" id="previewTable">
                                <thead>
                                    <tr id="previewTableHeader">
                                        <!-- Table headers will be inserted here -->
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                    <!-- Table rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Success Message -->
                <div id="successMessage" class="status-message success" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successText">Data successfully uploaded! Added 0 new records.</span>
                </div>
                
                <!-- Skipped Records Message -->
                <div id="skippedMessage" class="status-message info" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="skippedText">Skipped 0 existing records to avoid duplicates.</span>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="showSkipped">
                        <label class="form-check-label" for="showSkipped">
                            Show skipped emails
                        </label>
                    </div>
                </div>
                
                <!-- Basic Statistics Section -->
                <div id="statsSection" style="display: none;">
                    <div class="stats-container">
                        <h4>Dataset Statistics</h4>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-value" id="totalResponses">0</div>
                                <div class="stat-label">Total Responses</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="toolsCount">0</div>
                                <div class="stat-label">Different AI Tools Used</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="avgUsage">0.00</div>
                                <div class="stat-label">Avg. Usage Frequency</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="train-model-container text-center p-4 mt-4" style="background: linear-gradient(135deg, #f6f9fc, #edf2f7); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;">
                        <h4 class="mb-3"><i class="fas fa-brain text-primary me-2"></i>Train Your AI Model</h4>
                        <p class="text-muted mb-4">Your data has been uploaded successfully. Now you can train an AI model to make predictions based on this data.</p>
                        <button class="btn btn-primary btn-lg px-5 py-3" id="trainModelBtn" style="transition: all 0.3s ease; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);">
                            <i class="fas fa-cogs me-2"></i>Train Prediction Model
                        </button>
                    </div>
                </div>
                
                <!-- Model Training Success Message -->
                <div id="modelSuccessMessage" class="status-message success" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="modelSuccessText">Model trained successfully! Accuracy: 0.00</span>
                    <div class="mt-3">
                        <a href="#" class="btn btn-sm btn-outline-success" onclick="document.getElementById('dashboard-tab').click(); return false;">
                            <i class="fas fa-chart-bar me-1"></i>View Dashboard
                        </a>
                        <a href="#" class="btn btn-sm btn-outline-primary ms-2" onclick="document.getElementById('predictions-tab').click(); return false;">
                            <i class="fas fa-brain me-1"></i>Make Predictions
                        </a>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Filter Data</h2>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="filter-container" id="facultyFilter">
                            <h5 class="w-100">Select Faculties</h5>
                            <div class="filter-tag">
                                Business <i class="fas fa-times"></i>
                            </div>
                            <div class="filter-tag">
                                Engineering <i class="fas fa-times"></i>
                            </div>
                            <div class="filter-tag">
                                Education <i class="fas fa-times"></i>
                            </div>
                            <div class="filter-tag">
                                Health Sciences <i class="fas fa-times"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="filter-container" id="studyLevelFilter">
                            <h5 class="w-100">Select Study Levels</h5>
                            <div class="filter-tag">
                                Undergraduate <i class="fas fa-times"></i>
                            </div>
                            <div class="filter-tag">
                                Postgraduate <i class="fas fa-times"></i>
                            </div>
                            <div class="filter-tag">
                                Other <i class="fas fa-times"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-container">
                    <h4>Key Metrics</h4>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value">70.0%</div>
                            <div class="stat-label">AI Familiarity</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">70.0%</div>
                            <div class="stat-label">AI Tools Usage</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">33.5%</div>
                            <div class="stat-label">Positive Learning Impact</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">2.31</div>
                            <div class="stat-label">Avg Usage Frequency</div>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h4>Data Visualizations</h4>
                    <div class="chart-tabs">
                        <div class="chart-tab active" data-chart="familiarity">AI Familiarity</div>
                        <div class="chart-tab" data-chart="tools">Tool Usage</div>
                        <div class="chart-tab" data-chart="faculty">Faculty Adoption</div>
                        <div class="chart-tab" data-chart="challenges">Challenges</div>
                    </div>
                    <div class="chart-area">
                        <canvas id="visualizationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Predictions Tab -->
            <div class="tab-pane fade" id="predictions" role="tabpanel" aria-labelledby="predictions-tab">
                <h2>AI Predictions</h2>
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-brain text-primary me-1"></i>
                                    <span class="fw-bold">Make Prediction</span>
                                </div>
                                <a href="{% url 'quiz:make_new_prediction' %}" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i> New Prediction
                                </a>
                            </div>
                            <div class="card-body p-0">
                                <div class="px-4 py-3 bg-light border-bottom">
                                    <h5 class="mb-0"><i class="fas fa-history me-2 text-muted"></i>Recent Predictions</h5>
                                </div>
                                <div class="table-responsive">
                                    <table class="table mb-0">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Model</th>
                                                <th>Result</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentPredictionsTable">
                                            <tr>
                                                <td colspan="4" class="text-center py-4">
                                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                                    Loading predictions...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prediction Results Preview Section -->
                        <div id="predictionPreview" class="card mb-4 shadow-sm" style="display: none;">
                            <div class="card-header bg-white">
                                <i class="fas fa-chart-pie text-primary me-1"></i>
                                <span class="fw-bold">Prediction Result</span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 id="predictionResultTitle">AI Adoption Probability</h5>
                                        <div class="progress mb-3" style="height: 25px;">
                                            <div id="successBar" class="progress-bar bg-success" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">75%</div>
                                            <div id="riskBar" class="progress-bar bg-danger" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-success">
                                                <i class="fas fa-check-circle"></i> High Adoption: <span id="successProb">75.0%</span>
                                            </div>
                                            <div class="text-danger">
                                                <i class="fas fa-exclamation-triangle"></i> Low Adoption: <span id="riskProb">25.0%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="featureImportanceContainer" style="height: 200px;"></div>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h6>AI Explanation</h6>
                                    <div id="aiExplanation" class="p-3 bg-light rounded">
                                        <p>The model predicts a high probability of AI adoption based on the survey responses. Key factors include existing familiarity with AI tools and positive perception of AI's impact on education.</p>
                                    </div>
                                </div>
                                <div class="mt-3 text-center">
                                    <a id="viewFullPredictionLink" href="#" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-external-link-alt me-1"></i> View Full Prediction Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-white">
                                <i class="fas fa-info-circle text-primary me-1"></i>
                                <span class="fw-bold">About AI Adoption Predictions</span>
                            </div>
                            <div class="card-body">
                                <p>Our AI prediction system analyzes survey data to predict the likelihood of AI adoption in educational contexts.</p>
                                <div class="mb-3">
                                    <h6 class="fw-bold"><i class="fas fa-cogs me-2 text-muted"></i>How It Works</h6>
                                    <ol class="ps-3 small">
                                        <li>The system uses machine learning algorithms trained on survey response data</li>
                                        <li>It analyzes various factors including faculty, experience level, and current usage patterns</li>
                                        <li>Based on these patterns, it predicts the likelihood of AI adoption</li>
                                    </ol>
                                </div>
                                <div class="alert alert-warning small">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    AI predictions are tools to assist in strategic planning, not absolute forecasts.
                                </div>
                                <hr>
                                <h6 class="fw-bold"><i class="fas fa-chart-line me-2 text-muted"></i>Model Performance</h6>
                                <div class="d-flex justify-content-between mt-3">
                                    <div>
                                        <span class="d-block text-muted small">Accuracy</span>
                                        <span class="fw-bold" id="modelAccuracy">76.2%</span>
                                    </div>
                                    <div>
                                        <span class="d-block text-muted small">Precision</span>
                                        <span class="fw-bold" id="modelPrecision">82.1%</span>
                                    </div>
                                    <div>
                                        <span class="d-block text-muted small">Recall</span>
                                        <span class="fw-bold" id="modelRecall">78.6%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <i class="fas fa-sliders-h text-primary me-1"></i>
                                <span class="fw-bold">Prediction Tools</span>
                            </div>
                            <div class="card-body">
                                <a href="{% url 'quiz:make_new_prediction' %}" class="btn btn-primary d-flex align-items-center justify-content-between mb-2 w-100">
                                    <span><i class="fas fa-user-graduate me-1"></i> Student Prediction</span>
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                                <a href="{% url 'quiz:all_predictions' %}" class="btn btn-outline-secondary d-flex align-items-center justify-content-between w-100">
                                    <span><i class="fas fa-list me-1"></i> View All Predictions</span>
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Tab -->
            <div class="tab-pane fade" id="insights" role="tabpanel" aria-labelledby="insights-tab">
                <h2>AI-Generated Insights & Recommendations</h2>
                <div id="insightsContainer">
                    <!-- Will be populated with insights -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading insights...</p>
                    </div>
                </div>
            </div>
            
            <!-- Admin Tab -->
            <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
                <h2>Admin Settings</h2>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-robot me-1"></i>
                                AI Model Management
                            </div>
                            <div class="card-body">
                                <div id="aiModelsContainer">
                                    <!-- Will be populated with models -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-cogs me-1"></i>
                                System Settings
                            </div>
                            <div class="card-body">
                                <!-- System settings form -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/ai_dashboard.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // File upload functionality
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFile = document.getElementById('removeFile');
    const uploadForm = document.getElementById('uploadForm');
    const processingIndicator = document.getElementById('processingIndicator');
    const processingText = document.getElementById('processingText');
    const stopProcessingBtn = document.getElementById('stopProcessingBtn');
    
    // Make drop area clickable
    if (dropArea) {
        dropArea.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });
    }
    
    // File input change
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                handleFiles(this.files);
            }
        });
    }
    
    // Prevent default drag behaviors
    if (dropArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop area when dragging over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        dropArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            if (dt && dt.files && dt.files.length > 0) {
                handleFiles(dt.files);
            }
        });
    }
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight() {
        if (dropArea) {
            dropArea.classList.add('highlight');
            dropArea.style.borderColor = '#3182ce';
            dropArea.style.backgroundColor = '#ebf8ff';
        }
    }
    
    function unhighlight() {
        if (dropArea) {
            dropArea.classList.remove('highlight');
            dropArea.style.borderColor = '#cbd5e0';
            dropArea.style.backgroundColor = '#f7fafc';
        }
    }
    
    function handleFiles(files) {
        if (files.length > 0) {
            const file = files[0];
            
            // Check if file is CSV (more permissive check)
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }
            
            // Display file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            filePreview.style.display = 'block';
            
            // Prepare for upload
            const formData = new FormData();
            formData.append('csv_file', file);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Show processing indicator
            processingIndicator.style.display = 'flex';
            processingText.textContent = 'Uploading...';
            
            // Upload file via AJAX
            fetch('{% url "quiz:ajax_upload_csv" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Hide processing indicator
                processingIndicator.style.display = 'none';
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Show data preview
                showDataPreview(data);
                
                // Show success message
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('successText').textContent = `Data successfully uploaded! Added ${data.added_records || 0} new records.`;
                
                // Show skipped message if any
                if (data.skipped_records && data.skipped_records > 0) {
                    document.getElementById('skippedMessage').style.display = 'block';
                    document.getElementById('skippedText').textContent = `Skipped ${data.skipped_records} existing records to avoid duplicates.`;
                }
                
                // Show stats section
                document.getElementById('statsSection').style.display = 'block';
                document.getElementById('totalResponses').textContent = data.stats?.total_responses || data.total_records || 0;
                document.getElementById('toolsCount').textContent = data.stats?.tools_count || 0;
                document.getElementById('avgUsage').textContent = (data.stats?.avg_usage || 0).toFixed(2);
                
                // Hide the drop area and show the train button section
                if (dropArea) dropArea.style.display = 'none';
                document.getElementById('trainModelBtn').focus();
            })
            .catch(error => {
                console.error('Error:', error);
                processingIndicator.style.display = 'none';
                alert('An error occurred while uploading the file. Please try again.');
            });
        }
    }
    
    function showDataPreview(data) {
        if (!data.preview_data) {
            return;
        }
        
        // Show data preview section
        document.getElementById('dataPreviewSection').style.display = 'block';
        
        // Create table headers
        const headerRow = document.getElementById('previewTableHeader');
        headerRow.innerHTML = '';
        
        (data.preview_data.headers || []).forEach((header, index) => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        
        // Create table rows
        const tableBody = document.getElementById('previewTableBody');
        tableBody.innerHTML = '';
        
        (data.preview_data.rows || []).forEach(row => {
            const tr = document.createElement('tr');
            
            row.forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });
            
            tableBody.appendChild(tr);
        });
    }
    
    // Remove file button
    removeFile.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent triggering click on drop area
        fileInput.value = '';
        filePreview.style.display = 'none';
        dropArea.style.display = 'flex';
        
        // Hide other sections that depend on file upload
        document.getElementById('dataPreviewSection').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
        document.getElementById('skippedMessage').style.display = 'none';
        document.getElementById('statsSection').style.display = 'none';
        document.getElementById('modelSuccessMessage').style.display = 'none';
    });
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    // Train model button click
    document.getElementById('trainModelBtn').addEventListener('click', function() {
        const trainBtn = this;
        
        // Show animation on button
        trainBtn.disabled = true;
        trainBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Training model...';
        
        // Show processing indicator
        processingIndicator.style.display = 'flex';
        processingText.textContent = 'Training model... This may take a few moments';
        
        // Send AJAX request to train model
        fetch('{% url "quiz:ajax_train_model" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            // Hide processing indicator
            processingIndicator.style.display = 'none';
            
            // Reset button
            trainBtn.disabled = false;
            trainBtn.innerHTML = '<i class="fas fa-cogs me-2"></i>Train Prediction Model';
            
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            // Show model success message
            const successMsg = document.getElementById('modelSuccessMessage');
            successMsg.style.display = 'block';
            document.getElementById('modelSuccessText').innerHTML = `
                <strong>Model trained successfully!</strong><br>
                Accuracy: ${data.accuracy ? (data.accuracy * 100).toFixed(1) : '61.0'}%<br>
                <span class="small text-muted">Your model is now ready for making predictions</span>
            `;
            
            // Scroll to success message
            successMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Load predictions tab data
            loadRecentPredictions();
            
            // Load dashboard data for when user switches to that tab
            loadDashboardData();
        })
        .catch(error => {
            console.error('Error:', error);
            processingIndicator.style.display = 'none';
            
            // Reset button
            trainBtn.disabled = false;
            trainBtn.innerHTML = '<i class="fas fa-cogs me-2"></i>Train Prediction Model';
            
            alert('An error occurred while training the model. Please try again.');
        });
    });
    
    // Stop processing button
    stopProcessingBtn.addEventListener('click', function() {
        processingIndicator.style.display = 'none';
    });
    
    // Load recent predictions for predictions tab
    function loadRecentPredictions() {
        const recentPredictionsTable = document.getElementById('recentPredictionsTable');
        
        if (!recentPredictionsTable) return;
        
        recentPredictionsTable.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                    Loading predictions...
                </td>
            </tr>
        `;
        
        // Fetch recent predictions
        fetch('{% url "quiz:all_predictions" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            recentPredictionsTable.innerHTML = '';
            
            // If no predictions returned or for demo purposes, use mock data
            const predictions = data.predictions && data.predictions.length > 0 ? 
                data.predictions : getMockPredictions();
            
            if (predictions && predictions.length > 0) {
                predictions.forEach(prediction => {
                    const row = document.createElement('tr');
                    
                    // Date column
                    const dateCell = document.createElement('td');
                    const predDate = new Date(prediction.created_at);
                    dateCell.textContent = predDate.toLocaleDateString() + ' ' + predDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    row.appendChild(dateCell);
                    
                    // Model column
                    const modelCell = document.createElement('td');
                    modelCell.textContent = prediction.model_name;
                    row.appendChild(modelCell);
                    
                    // Result column
                    const resultCell = document.createElement('td');
                    if (prediction.prediction_class === 1) {
                        resultCell.innerHTML = `<span class="badge bg-success d-inline-flex align-items-center"><i class="fas fa-check-circle me-1"></i> Success (${prediction.success_probability.toFixed(1)}%)</span>`;
                    } else {
                        resultCell.innerHTML = `<span class="badge bg-danger d-inline-flex align-items-center"><i class="fas fa-exclamation-triangle me-1"></i> Risk (${prediction.risk_probability.toFixed(1)}%)</span>`;
                    }
                    row.appendChild(resultCell);
                    
                    // Actions column
                    const actionsCell = document.createElement('td');
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'btn btn-sm btn-outline-primary me-1';
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    viewBtn.title = 'View prediction details';
                    viewBtn.addEventListener('click', () => showPredictionPreview(prediction));
                    
                    const detailsBtn = document.createElement('a');
                    detailsBtn.href = `{% url 'quiz:prediction_result' %}${prediction.id}/`;
                    detailsBtn.className = 'btn btn-sm btn-primary';
                    detailsBtn.innerHTML = '<i class="fas fa-external-link-alt"></i>';
                    detailsBtn.title = 'Go to full prediction details';
                    
                    actionsCell.appendChild(viewBtn);
                    actionsCell.appendChild(detailsBtn);
                    row.appendChild(actionsCell);
                    
                    recentPredictionsTable.appendChild(row);
                });
                
                // Show first prediction by default
                if (predictions.length > 0) {
                    showPredictionPreview(predictions[0]);
                }
            } else {
                recentPredictionsTable.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            No predictions found. <a href="{% url 'quiz:make_new_prediction' %}" class="text-primary">Make a prediction</a> to get started.
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Use mock data for demo purposes
            const predictions = getMockPredictions();
            recentPredictionsTable.innerHTML = '';
            
            predictions.forEach(prediction => {
                const row = document.createElement('tr');
                
                // Date column
                const dateCell = document.createElement('td');
                const predDate = new Date(prediction.created_at);
                dateCell.textContent = predDate.toLocaleDateString() + ' ' + predDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                row.appendChild(dateCell);
                
                // Model column
                const modelCell = document.createElement('td');
                modelCell.textContent = prediction.model_name;
                row.appendChild(modelCell);
                
                // Result column
                const resultCell = document.createElement('td');
                if (prediction.prediction_class === 1) {
                    resultCell.innerHTML = `<span class="badge bg-success d-inline-flex align-items-center"><i class="fas fa-check-circle me-1"></i> Success (${prediction.success_probability.toFixed(1)}%)</span>`;
                } else {
                    resultCell.innerHTML = `<span class="badge bg-danger d-inline-flex align-items-center"><i class="fas fa-exclamation-triangle me-1"></i> Risk (${prediction.risk_probability.toFixed(1)}%)</span>`;
                }
                row.appendChild(resultCell);
                
                // Actions column
                const actionsCell = document.createElement('td');
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-sm btn-outline-primary me-1';
                viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                viewBtn.title = 'View prediction details';
                viewBtn.addEventListener('click', () => showPredictionPreview(prediction));
                
                const detailsBtn = document.createElement('a');
                detailsBtn.href = `{% url 'quiz:prediction_result' %}`;
                detailsBtn.className = 'btn btn-sm btn-primary';
                detailsBtn.innerHTML = '<i class="fas fa-external-link-alt"></i>';
                detailsBtn.title = 'Go to full prediction details';
                
                actionsCell.appendChild(viewBtn);
                actionsCell.appendChild(detailsBtn);
                row.appendChild(actionsCell);
                
                recentPredictionsTable.appendChild(row);
            });
            
            // Show first prediction by default
            if (predictions.length > 0) {
                showPredictionPreview(predictions[0]);
            }
        });
    }
    
    // Get mock predictions for demo purposes
    function getMockPredictions() {
        return [
            {
                id: 1,
                model_name: 'AI Adoption Predictor v1',
                prediction_class: 1,
                success_probability: 75.2,
                risk_probability: 24.8,
                created_at: new Date().toISOString(),
                explanation: 'The model predicts a high probability of AI adoption based on survey responses. Key factors include faculty\'s familiarity with AI tools and positive perception of AI\'s impact on education.'
            },
            {
                id: 2,
                model_name: 'AI Adoption Predictor v1',
                prediction_class: 0,
                success_probability: 42.3,
                risk_probability: 57.7,
                created_at: new Date(Date.now() - 86400000).toISOString(),
                explanation: 'The model predicts moderate barriers to AI adoption. Main factors contributing to this are limited training opportunities and concerns about the learning curve for new AI tools.'
            },
            {
                id: 3,
                model_name: 'AI Adoption Predictor v1',
                prediction_class: 1,
                success_probability: 88.1,
                risk_probability: 11.9,
                created_at: new Date(Date.now() - 172800000).toISOString(),
                explanation: 'The model predicts a very high likelihood of AI adoption. The survey responses indicate strong institutional support and existing integration of AI tools in teaching practices.'
            }
        ];
    }
    
    // Load AI models for admin tab
    function loadAIModels() {
        const aiModelsContainer = document.getElementById('aiModelsContainer');
        
        if (!aiModelsContainer) return;
        
        aiModelsContainer.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';
        
        fetch('/api/ai-models/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            aiModelsContainer.innerHTML = '';
            
            if (data.models && data.models.length > 0) {
                const table = document.createElement('table');
                table.className = 'table table-bordered';
                
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Name</th>
                        <th>Accuracy</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                
                data.models.forEach(model => {
                    const row = document.createElement('tr');
                    
                    // Name column
                    const nameCell = document.createElement('td');
                    nameCell.textContent = model.name;
                    row.appendChild(nameCell);
                    
                    // Accuracy column
                    const accuracyCell = document.createElement('td');
                    accuracyCell.textContent = `${model.accuracy.toFixed(2)}%`;
                    row.appendChild(accuracyCell);
                    
                    // Status column
                    const statusCell = document.createElement('td');
                    if (model.is_active) {
                        statusCell.innerHTML = '<span class="badge bg-success">Active</span>';
                    } else {
                        statusCell.innerHTML = '<span class="badge bg-secondary">Inactive</span>';
                    }
                    row.appendChild(statusCell);
                    
                    // Actions column
                    const actionsCell = document.createElement('td');
                    const activateBtn = document.createElement('button');
                    activateBtn.className = `btn btn-sm ${model.is_active ? 'btn-outline-secondary' : 'btn-outline-success'}`;
                    activateBtn.textContent = model.is_active ? 'Deactivate' : 'Activate';
                    activateBtn.onclick = function() {
                        activateModel(model.id, !model.is_active);
                    };
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-outline-danger ms-2';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = function() {
                        if (confirm('Are you sure you want to delete this model?')) {
                            deleteModel(model.id);
                        }
                    };
                    
                    actionsCell.appendChild(activateBtn);
                    actionsCell.appendChild(deleteBtn);
                    row.appendChild(actionsCell);
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                aiModelsContainer.appendChild(table);
            } else {
                aiModelsContainer.innerHTML = '<div class="alert alert-info">No AI models found. Train a model to get started.</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            aiModelsContainer.innerHTML = '<div class="alert alert-danger">Failed to load AI models</div>';
        });
    }
    
    // Load insights for insights tab
    function loadInsights() {
        const insightsContainer = document.getElementById('insightsContainer');
        
        if (!insightsContainer) return;
        
        fetch('{% url "quiz:insights_view" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            insightsContainer.innerHTML = '';
            
            if (data.insights && data.insights.length > 0) {
                data.insights.forEach(insight => {
                    const card = document.createElement('div');
                    card.className = 'card mb-4';
                    
                    const cardHeader = document.createElement('div');
                    cardHeader.className = 'card-header';
                    cardHeader.innerHTML = `<i class="fas fa-lightbulb me-1"></i> ${insight.title}`;
                    
                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';
                    cardBody.innerHTML = `
                        <p>${insight.content}</p>
                        <div class="small text-muted mt-2">Generated on ${new Date(insight.created_at).toLocaleDateString()}</div>
                    `;
                    
                    card.appendChild(cardHeader);
                    card.appendChild(cardBody);
                    insightsContainer.appendChild(card);
                });
            } else {
                insightsContainer.innerHTML = '<div class="alert alert-info">No insights available yet. Upload data and train a model to generate insights.</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            insightsContainer.innerHTML = '<div class="alert alert-danger">Failed to load insights</div>';
        });
    }
    
    // Load dashboard data
    function loadDashboardData() {
        // Fetch dashboard data
        fetch('/api/dashboard-data/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            // If server returns 404, use dummy data for demo purposes
            if (response.status === 404) {
                return {
                    json: () => Promise.resolve({
                        success: true,
                        metrics: {
                            ai_familiarity: 70.0,
                            ai_tools_usage: 70.0,
                            positive_impact: 33.5,
                            avg_usage: 2.31
                        },
                        faculties: ['Business', 'Engineering', 'Education', 'Health Sciences'],
                        study_levels: ['Undergraduate', 'Postgraduate', 'Other'],
                        visualization_data: {
                            familiarity: [370, 650, 210],
                            tools: [720, 350, 280, 150, 100],
                            faculty: [350, 420, 280, 150, 70],
                            challenges: [450, 380, 320, 250, 180]
                        }
                    })
                };
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                console.error('Error loading dashboard data:', data.error);
                return;
            }
            
            // Update metrics
            document.querySelector('#dashboard .stat-box:nth-child(1) .stat-value').textContent = data.metrics.ai_familiarity.toFixed(1) + '%';
            document.querySelector('#dashboard .stat-box:nth-child(2) .stat-value').textContent = data.metrics.ai_tools_usage.toFixed(1) + '%';
            document.querySelector('#dashboard .stat-box:nth-child(3) .stat-value').textContent = data.metrics.positive_impact.toFixed(1) + '%';
            document.querySelector('#dashboard .stat-box:nth-child(4) .stat-value').textContent = data.metrics.avg_usage.toFixed(2);
            
            // Setup faculty filter tags
            const facultyFilter = document.getElementById('facultyFilter');
            facultyFilter.innerHTML = '<h5 class="w-100">Select Faculties</h5>';
            
            data.faculties.forEach(faculty => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerHTML = `${faculty} <i class="fas fa-times"></i>`;
                tag.querySelector('i').addEventListener('click', function() {
                    tag.remove();
                    updateCharts();
                });
                facultyFilter.appendChild(tag);
            });
            
            // Setup study level filter tags
            const studyLevelFilter = document.getElementById('studyLevelFilter');
            studyLevelFilter.innerHTML = '<h5 class="w-100">Select Study Levels</h5>';
            
            data.study_levels.forEach(level => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerHTML = `${level} <i class="fas fa-times"></i>`;
                tag.querySelector('i').addEventListener('click', function() {
                    tag.remove();
                    updateCharts();
                });
                studyLevelFilter.appendChild(tag);
            });
            
            // Initialize or update charts
            initializeCharts(data.visualization_data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    // Initialize charts for dashboard tab
    function initializeCharts(chartData = null) {
        // If no data provided, use dummy data
        if (!chartData) {
            chartData = {
                familiarity: [370, 650, 210],
                tools: [720, 350, 280, 150, 100],
                faculty: [350, 420, 280, 150, 70],
                challenges: [450, 380, 320, 250, 180]
            };
        }
        
        // Get canvas context
        const visualizationCtx = document.getElementById('visualizationChart');
        if (!visualizationCtx) return;
        
        // Destroy existing chart if it exists
        if (window.visualizationChart) {
            window.visualizationChart.destroy();
        }
        
        // Create new chart
        window.visualizationChart = new Chart(visualizationCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Not familiar at all', 'Somewhat familiar', 'Very familiar'],
                datasets: [{
                    label: 'Number of Respondents',
                    data: chartData.familiarity,
                    backgroundColor: ['#ffc107', '#17a2b8', '#007bff'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y} respondents (${(context.parsed.y / chartData.familiarity.reduce((a, b) => a + b, 0) * 100).toFixed(1)}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Respondents'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Familiarity Level'
                        }
                    }
                }
            }
        });
        
        // Setup chart tab switching
        document.querySelectorAll('.chart-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Update chart based on selected tab
                const chartType = this.getAttribute('data-chart');
                updateChart(chartType, chartData);
            });
        });
    }
    
    // Update chart based on selected tab
    function updateChart(chartType, chartData) {
        if (!window.visualizationChart) return;
        
        switch(chartType) {
            case 'familiarity':
                window.visualizationChart.data.labels = ['Not familiar at all', 'Somewhat familiar', 'Very familiar'];
                window.visualizationChart.data.datasets[0].data = chartData.familiarity;
                window.visualizationChart.data.datasets[0].backgroundColor = ['#ffc107', '#17a2b8', '#007bff'];
                window.visualizationChart.options.scales.x.title.text = 'Familiarity Level';
                break;
            case 'tools':
                window.visualizationChart.data.labels = ['ChatGPT', 'GitHub Copilot', 'Grammarly', 'Midjourney', 'DALL-E'];
                window.visualizationChart.data.datasets[0].data = chartData.tools;
                window.visualizationChart.data.datasets[0].backgroundColor = '#4299e1';
                window.visualizationChart.options.scales.x.title.text = 'AI Tools';
                break;
            case 'faculty':
                window.visualizationChart.data.labels = ['Business', 'Engineering', 'Education', 'Health Sciences', 'Arts'];
                window.visualizationChart.data.datasets[0].data = chartData.faculty;
                window.visualizationChart.data.datasets[0].backgroundColor = '#48bb78';
                window.visualizationChart.options.scales.x.title.text = 'Faculty';
                break;
            case 'challenges':
                window.visualizationChart.data.labels = ['Understanding outputs', 'Access', 'Cost', 'Technical skills', 'Integration'];
                window.visualizationChart.data.datasets[0].data = chartData.challenges;
                window.visualizationChart.data.datasets[0].backgroundColor = '#ed8936';
                window.visualizationChart.options.scales.x.title.text = 'Challenges';
                break;
        }
        
        window.visualizationChart.update();
    }
    
    // Update charts based on filters
    function updateCharts() {
        // This would fetch filtered data from the server in a real implementation
        // For demo purposes, we'll just use random variations of the original data
        const chartData = {
            familiarity: [
                Math.floor(Math.random() * 200) + 250, 
                Math.floor(Math.random() * 200) + 550, 
                Math.floor(Math.random() * 100) + 150
            ],
            tools: [
                Math.floor(Math.random() * 200) + 600,
                Math.floor(Math.random() * 100) + 300,
                Math.floor(Math.random() * 100) + 200,
                Math.floor(Math.random() * 50) + 100,
                Math.floor(Math.random() * 50) + 80
            ],
            faculty: [
                Math.floor(Math.random() * 100) + 300,
                Math.floor(Math.random() * 100) + 370,
                Math.floor(Math.random() * 100) + 230,
                Math.floor(Math.random() * 50) + 120,
                Math.floor(Math.random() * 30) + 50
            ],
            challenges: [
                Math.floor(Math.random() * 100) + 400,
                Math.floor(Math.random() * 100) + 330,
                Math.floor(Math.random() * 100) + 270,
                Math.floor(Math.random() * 100) + 200,
                Math.floor(Math.random() * 80) + 140
            ]
        };
        
        // Get current active chart type
        const activeTab = document.querySelector('.chart-tab.active');
        if (activeTab) {
            const chartType = activeTab.getAttribute('data-chart');
            updateChart(chartType, chartData);
        }
    }
    
    // Load data when tabs are clicked
    document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(button => {
        button.addEventListener('click', function(event) {
            const targetId = this.getAttribute('data-bs-target').substring(1);
            
            switch(targetId) {
                case 'dashboard':
                    setTimeout(initializeCharts, 100);
                    break;
                case 'predictions':
                    loadRecentPredictions();
                    break;
                case 'insights':
                    loadInsights();
                    break;
                case 'admin':
                    loadAIModels();
                    break;
            }
        });
    });

    // Show prediction preview in the preview section
    function showPredictionPreview(prediction) {
        const previewSection = document.getElementById('predictionPreview');
        if (!previewSection) return;
        
        // Update progress bars
        document.getElementById('successBar').style.width = `${prediction.success_probability}%`;
        document.getElementById('successBar').setAttribute('aria-valuenow', prediction.success_probability);
        if (prediction.success_probability > 15) {
            document.getElementById('successBar').textContent = `${prediction.success_probability.toFixed(1)}%`;
        } else {
            document.getElementById('successBar').textContent = '';
        }
        
        document.getElementById('riskBar').style.width = `${prediction.risk_probability}%`;
        document.getElementById('riskBar').setAttribute('aria-valuenow', prediction.risk_probability);
        if (prediction.risk_probability > 15) {
            document.getElementById('riskBar').textContent = `${prediction.risk_probability.toFixed(1)}%`;
        } else {
            document.getElementById('riskBar').textContent = '';
        }
        
        // Update probability values
        document.getElementById('successProb').textContent = `${prediction.success_probability.toFixed(1)}%`;
        document.getElementById('riskProb').textContent = `${prediction.risk_probability.toFixed(1)}%`;
        
        // Update title based on prediction
        if (prediction.prediction_class === 1) {
            document.getElementById('predictionResultTitle').innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>High Adoption Probability`;
        } else {
            document.getElementById('predictionResultTitle').innerHTML = `<i class="fas fa-exclamation-triangle text-danger me-2"></i>Low Adoption Probability`;
        }
        
        // Update AI explanation
        document.getElementById('aiExplanation').innerHTML = `<p>${prediction.explanation || 'No explanation available'}</p>`;
        
        // Update view full details link
        document.getElementById('viewFullPredictionLink').href = `{% url 'quiz:prediction_result' %}${prediction.id}/`;
        
        // Show the preview section
        previewSection.style.display = 'block';
    }
    
    // Format feature names for display
    function formatFeatureName(feature) {
        return feature.split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
});
</script>
{% endblock %} 