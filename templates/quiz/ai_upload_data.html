{% extends 'quiz/adminbase.html' %}
{% load static %}

{% block styles %}
<style>
    .step-icon {
        transition: transform 0.3s ease;
    }
    .step-active .step-icon {
        transform: scale(1.1);
    }
    .card {
        transition: all 0.3s ease;
    }
    .progress-bar-step {
        height: 6px;
        transition: width 0.5s ease;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    .pulse-animation {
        animation: pulse 1.5s infinite;
    }
</style>
{% endblock %}

{% block content %}

<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <h2 class="mb-4">AI Adoption Data Management</h2>
      
      <!-- Action Buttons -->
      <div class="mb-4">
        <a href="{% url 'ai_model_metrics' %}" class="btn btn-primary mr-2" id="model-metrics-btn">
          <i class="fas fa-chart-line"></i> Model Metrics
        </a>
        <a href="{% url 'ai_prediction_form' %}" class="btn btn-success mr-2" id="make-prediction-btn">
          <i class="fas fa-brain"></i> Make Prediction
        </a>
        <a href="{% url 'ai_view_data_list' %}" class="btn btn-info mr-2" id="view-data-btn">
          <i class="fas fa-table"></i> View All Data
        </a>
        <button id="train-existing-data" name="train-existing-data" class="btn btn-warning">
          <i class="fas fa-cogs"></i> Train Model on Existing Data
        </button>
        <form method="post" action="{% url 'train_model_view' %}" class="d-inline" id="direct-train-form">
          {% csrf_token %}
          <input type="hidden" name="algorithm" id="algorithm" value="random_forest">
          <button type="submit" class="btn btn-outline-warning" id="direct-train-btn" name="direct-train-btn">
            <i class="fas fa-cogs"></i> Direct Train (No AJAX)
          </button>
        </form>
      </div>
      
      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white" id="total-records-card">
            <div class="card-body">
              <h5 class="card-title">Total Records</h5>
              <h2 id="total-records">{{ total_records }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white" id="model-count-card">
            <div class="card-body">
              <h5 class="card-title">Models</h5>
              <h2 id="model-count">{{ model_count }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white" id="best-accuracy-card">
            <div class="card-body">
              <h5 class="card-title">Best Accuracy</h5>
              <h2 id="best-accuracy">{{ best_accuracy }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white" id="last-upload-card">
            <div class="card-body">
              <h5 class="card-title">Last Upload</h5>
              <h2 id="last-upload">{{ last_upload }}</h2>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Upload Form -->
      <div class="card mb-4" id="upload-form-card">
        <div class="card-header">
          <h5>Upload Survey Data</h5>
        </div>
        <div class="card-body">
          <!-- Multi-stage upload form -->
          <form id="uploadForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="custom-file mb-3">
              <input type="file" class="custom-file-input" id="csv-file" name="csv_file" required accept=".csv">
              <label class="custom-file-label" for="csv-file">Choose CSV file</label>
              <small class="form-text text-muted">Upload a CSV file with AI adoption survey data</small>
            </div>
            
            <div class="form-row">
              <div class="col-md-6">
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="clean-data" name="clean_data" checked>
                  <label class="form-check-label" for="clean-data">
                    Clean and standardize data
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="train-model" name="train_model" checked>
                  <label class="form-check-label" for="train-model">
                    Train model after upload
                  </label>
                </div>
              </div>
            </div>
            
            <div class="form-row mb-3">
              <div class="col-md-12">
                <button type="submit" class="btn btn-primary" id="upload-btn">
                  <i class="fas fa-upload"></i> Upload & Process
                </button>
                <form action="{% url 'upload_csv_view' %}" method="post" enctype="multipart/form-data" class="d-inline">
                  {% csrf_token %}
                  <input type="hidden" name="csv_file" id="standard-form-file">
                  <button type="submit" class="btn btn-outline-secondary ml-2" id="direct-upload-btn">
                    <i class="fas fa-external-link-alt"></i> Standard Form Upload
                  </button>
                </form>
              </div>
            </div>
          </form>
          
          <!-- Enhanced Progress Indicators -->
          <div id="upload-progress-container" class="mt-4 d-none">
            <h6 class="text-muted mb-2">Processing Status</h6>
            
            <div class="progress mb-3" style="height: 25px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" id="overall-progress"
                   role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                0%
              </div>
            </div>
            
            <div class="row mt-4">
              <div class="col-md-4">
                <div class="card h-100" id="step-upload">
                  <div class="card-body p-3 text-center">
                    <div class="step-icon mb-2">
                      <i class="fas fa-upload fa-2x"></i>
                    </div>
                    <h6 class="mb-1">File Upload</h6>
                    <div class="progress mt-2 mb-2" style="height: 5px;">
                      <div class="progress-bar" id="upload-progress-bar" role="progressbar" style="width: 0%"
                           aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted" id="upload-status">Pending</small>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card h-100" id="step-clean">
                  <div class="card-body p-3 text-center">
                    <div class="step-icon mb-2">
                      <i class="fas fa-broom fa-2x"></i>
                    </div>
                    <h6 class="mb-1">Data Cleaning</h6>
                    <div class="progress mt-2 mb-2" style="height: 5px;">
                      <div class="progress-bar" id="clean-progress-bar" role="progressbar" style="width: 0%"
                           aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted" id="clean-status">Pending</small>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card h-100" id="step-train">
                  <div class="card-body p-3 text-center">
                    <div class="step-icon mb-2">
                      <i class="fas fa-cogs fa-2x"></i>
                    </div>
                    <h6 class="mb-1">Model Training</h6>
                    <div class="progress mt-2 mb-2" style="height: 5px;">
                      <div class="progress-bar" id="train-progress-bar" role="progressbar" style="width: 0%"
                           aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted" id="train-status">Pending</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Result Display -->
          <div id="upload-result" class="mt-4 d-none">
            <div class="card">
              <div class="card-header d-flex align-items-center" id="result-header">
                <i class="fas fa-check-circle text-success mr-2" id="result-icon"></i>
                <h5 class="mb-0" id="result-title">Success</h5>
              </div>
              <div class="card-body">
                <p class="mb-2" id="result-message"></p>
                
                <div class="row mt-3">
                  <div class="col-md-4">
                    <div class="card bg-light">
                      <div class="card-body p-3 text-center">
                        <h6 class="text-muted mb-0">Records Processed</h6>
                        <h3 id="records-processed">0</h3>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="card bg-light">
                      <div class="card-body p-3 text-center">
                        <h6 class="text-muted mb-0">Processing Time</h6>
                        <h3 id="processing-time">0s</h3>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <div class="card bg-light">
                      <div class="card-body p-3 text-center">
                        <h6 class="text-muted mb-0">Model Accuracy</h6>
                        <h3 id="model-accuracy">N/A</h3>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div id="insights-container" class="mt-3">
                  <h6>Key Insights:</h6>
                  <ul class="list-group" id="insights-list"></ul>
                </div>
                
                <div class="mt-3">
                  <button class="btn btn-primary" id="view-data-button">
                    <i class="fas fa-eye"></i> View Data
                  </button>
                  <button class="btn btn-outline-primary" id="upload-another">
                    <i class="fas fa-plus"></i> Upload Another File
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Upload History -->
      <div class="card">
        <div class="card-header">
          <h5>Upload History</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="upload-history-table">
              <thead>
                <tr>
                  <th id="col-filename">Filename</th>
                  <th id="col-records">Records</th>
                  <th id="col-status">Status</th>
                  <th id="col-date">Date</th>
                  <th id="col-actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for upload in upload_history %}
                <tr id="upload-row-{{ upload.id }}">
                  <td>{{ upload.original_filename }}</td>
                  <td>{{ upload.record_count }}</td>
                  <td>
                    <span class="badge badge-{% if upload.status == 'completed' %}success{% elif upload.status == 'failed' %}danger{% else %}warning{% endif %}" id="status-badge-{{ upload.id }}">
                      {{ upload.status|title }}
                    </span>
                  </td>
                  <td>{{ upload.created_at|date:"M d, Y H:i" }}</td>
                  <td>
                    <a href="{% url 'ai_data_detail' upload.id %}" class="btn btn-sm btn-info" id="view-btn-{{ upload.id }}">
                      <i class="fas fa-eye"></i> View
                    </a>
                    <button class="btn btn-sm btn-danger delete-upload" data-id="{{ upload.id }}" id="delete-btn-{{ upload.id }}">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                {% empty %}
                <tr id="no-uploads-row">
                  <td colspan="5" class="text-center">No uploads yet</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="close-modal-x">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this upload? This will remove all data records associated with this upload.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancel-delete-btn">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDelete" name="confirmDelete">Delete</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Add DataTables CSS and JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css">
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>

<!-- Add confetti.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" integrity="sha256-QxZX8UEW1ZvLTEvqZYEV+D6qP7YyxYcZFj+6n2Cm/w=" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTables
    const dataTable = new DataTable('#upload-history-table', {
        order: [[3, 'desc']], // Sort by date column descending
        language: {
            emptyTable: 'No uploads yet'
        }
    });

    // API endpoints
    const API = {
        upload: "{% url 'upload_csv_view' %}",
        history: "{% url 'upload_history' %}",
        delete: "{% url 'delete_upload' 0 %}",
        viewData: "{% url 'ai_data_detail' 0 %}"
    };

    // CSRF token for AJAX requests
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Upload form and related elements
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('csv-file');
    const cleanDataCheckbox = document.getElementById('clean-data');
    const trainModelCheckbox = document.getElementById('train-model');
    const uploadBtn = document.getElementById('upload-btn');
    
    // Progress indicators
    const progressContainer = document.getElementById('upload-progress-container');
    const overallProgress = document.getElementById('overall-progress');
    const uploadProgressBar = document.getElementById('upload-progress-bar');
    const cleanProgressBar = document.getElementById('clean-progress-bar');
    const trainProgressBar = document.getElementById('train-progress-bar');
    const uploadStatus = document.getElementById('upload-status');
    const cleanStatus = document.getElementById('clean-status');
    const trainStatus = document.getElementById('train-status');
    
    // Result elements
    const resultContainer = document.getElementById('upload-result');
    const resultIcon = document.getElementById('result-icon');
    const resultTitle = document.getElementById('result-title');
    const resultMessage = document.getElementById('result-message');
    const recordsProcessed = document.getElementById('records-processed');
    const processingTime = document.getElementById('processing-time');
    const modelAccuracy = document.getElementById('model-accuracy');
    const insightsContainer = document.getElementById('insights-container');
    const insightsList = document.getElementById('insights-list');
    
    // Track upload ID for view data button
    let currentUploadId = null;
    let uploadStartTime = null;

    // File input change handler - update label with selected filename
    fileInput.addEventListener('change', function(e) {
        const fileName = e.target.value.split('\\').pop();
        this.nextElementSibling.textContent = fileName || 'Choose CSV file';
        
        // Validate file type
        if (fileName && !fileName.toLowerCase().endsWith('.csv')) {
            alert('Please select a CSV file');
            fileInput.value = '';
            this.nextElementSibling.textContent = 'Choose CSV file';
        }
    });
    
    // Form submission handler
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        if (!fileInput.files || !fileInput.files[0]) {
            alert('Please select a file to upload');
            return;
        }
        
        // Reset upload process state
        resetUploadState();
        
        // Record start time
        uploadStartTime = new Date();
        
        // Start upload process
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('csv_file', file);
        formData.append('clean_data', cleanDataCheckbox.checked.toString());
        formData.append('train_model', trainModelCheckbox.checked.toString());
        
        // Show progress UI
        uploadBtn.disabled = true;
        progressContainer.classList.remove('d-none');
        resultContainer.classList.add('d-none');
        
        // Set upload status
        updateUploadProgress(10, 'Starting...');
        
        // Send the upload request
        fetch(API.upload, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const uploadTime = ((new Date() - uploadStartTime) / 1000).toFixed(1);
            
            if (data.status === 'success') {
                // Update UI for success
                updateUploadProgress(100, 'Completed');
                updateCleanProgress(100, 'Completed');
                
                if (trainModelCheckbox.checked) {
                    updateTrainProgress(100, 'Completed');
                } else {
                    updateTrainProgress(0, 'Skipped');
                }
                
                // Store the upload ID
                currentUploadId = data.upload_id;
                
                // Show success UI
                showUploadSuccess(data, uploadTime);
                
                // Refresh history and stats
                refreshUploadHistory();
                
                // Show confetti animation
                if (typeof confetti === 'function') {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            } else {
                // Show error UI
                showUploadError(data);
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showUploadError({ message: error.message });
        })
        .finally(() => {
            // Re-enable upload button
            uploadBtn.disabled = false;
        });
    });
    
    // Handle "Upload Another" button
    document.getElementById('upload-another').addEventListener('click', function() {
        // Reset UI and form
        resultContainer.classList.add('d-none');
        fileInput.value = '';
        fileInput.nextElementSibling.textContent = 'Choose CSV file';
        uploadBtn.disabled = false;
    });
    
    // Handle "View Data" button
    document.getElementById('view-data-button').addEventListener('click', function() {
        if (currentUploadId) {
            window.location.href = API.viewData.replace('0', currentUploadId);
        }
    });
    
    // Delete functionality
    let deleteUploadId = null;
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-upload')) {
            deleteUploadId = e.target.closest('.delete-upload').dataset.id;
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }
    });
    
    document.getElementById('confirmDelete').addEventListener('click', function() {
        if (!deleteUploadId) return;
        
        const deleteUrl = API.delete.replace('$id', deleteUploadId);
        
        // Disable delete button and show loading
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...';
        
        fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(handleResponse)
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                showNotification('Upload deleted successfully', 'success');
                
                // Update stats and refresh table
                updateStats(data);
                refreshUploadHistory();
            } else {
                showNotification('Error deleting upload: ' + (data.message || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            showNotification('Error deleting upload: ' + error.message, 'danger');
        })
        .finally(() => {
            // Re-enable delete button
            document.getElementById('confirmDelete').disabled = false;
            document.getElementById('confirmDelete').innerHTML = 'Delete';
            
            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
        });
    });
    
    /**
     * Core upload functionality
     */
    function uploadFile(formData) {
        fetch(API.upload, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                // Don't set Content-Type header, browser will set it with boundary for multipart/form-data
            }
        })
        .then(handleResponse)
        .then(data => {
            // Stop progress simulation
            clearAllProgressIntervals();
            
            if (data.status === 'success') {
                // Update UI for upload success
                updateUploadProgress(100, 'Completed');
                updateCleanProgress(100, 'Completed');
                
                if (trainModelCheckbox.checked) {
                    updateTrainProgress(100, 'Completed');
                } else {
                    updateTrainProgress(0, 'Skipped');
                }
                
                updateOverallProgress(100);
                
                // Store the upload ID for view data button
                currentUploadId = data.upload_id;
                
                // Show success result after a brief delay
                setTimeout(() => {
                    showUploadSuccess(data);
                    
                    // Refresh table data
                    refreshUploadHistory();
                    
                    // Update stats
                    if (data.total_records !== undefined) {
                        updateStats(data);
                    } else {
                        // If stats aren't included, fetch them
                        fetchLatestStats();
                    }
                    
                    // Show confetti on success
                    if (typeof confetti === 'function') {
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                }, 500);
            } else {
                // Handle error
                showUploadError(data);
            }
        })
        .catch(error => {
            // Stop progress simulation
            clearAllProgressIntervals();
            
            // Show error state
            console.error('Upload failed:', error);
            showUploadError({ message: error.message || 'Network error occurred' });
        })
        .finally(() => {
            // Re-enable upload button
            uploadBtn.disabled = false;
        });
    }
    
    /**
     * Helper functions
     */
    
    // Handle fetch response and check for errors
    function handleResponse(response) {
        if (!response.ok) {
            // Try to get error message from response
            return response.json()
                .catch(() => {
                    // If we can't parse JSON, throw with status text
                    throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
                })
                .then(errorData => {
                    // If we got JSON with error, throw that
                    throw new Error(errorData.message || errorData.error || `HTTP error ${response.status}`);
                });
        }
        return response.json();
    }
    
    // Reset upload process state
    function resetUploadState() {
        // Reset progress indicators
        updateProgressUI('upload', 0, 'Pending');
        updateProgressUI('clean', 0, 'Pending');
        updateProgressUI('train', 0, 'Pending');
        
        // Reset UI elements
        document.getElementById('step-upload').classList.remove('bg-info', 'bg-success', 'bg-secondary', 'text-white');
        document.getElementById('step-clean').classList.remove('bg-info', 'bg-success', 'bg-secondary', 'text-white');
        document.getElementById('step-train').classList.remove('bg-info', 'bg-success', 'bg-secondary', 'text-white');
        
        // Clear any existing intervals
        clearAllProgressIntervals();
    }
    
    // Progress interval IDs
    let uploadInterval, cleanInterval, trainInterval, overallInterval;
    
    // Clear all progress simulation intervals
    function clearAllProgressIntervals() {
        [uploadInterval, cleanInterval, trainInterval, overallInterval].forEach(interval => {
            if (interval) clearInterval(interval);
        });
    }
    
    // Start simulating progress for better user experience
    function startProgressSimulation() {
        let uploadProgress = 0;
        let cleanProgress = 0;
        let trainProgress = 0;
        let overallProgress = 0;
        
        // Simulate upload progress (0-90%)
        uploadInterval = setInterval(() => {
            if (uploadProgress < 90) {
                uploadProgress += (90 - uploadProgress) / 10;
                updateUploadProgress(uploadProgress, 'Uploading...');
            } else {
                clearInterval(uploadInterval);
            }
        }, 300);
        
        // Simulate data cleaning progress starting after upload reaches 30%
        setTimeout(() => {
            updateCleanProgress(0, 'Starting...');
            document.getElementById('step-clean').classList.add('bg-info', 'text-white');
            
            cleanInterval = setInterval(() => {
                if (cleanProgress < 90) {
                    cleanProgress += (90 - cleanProgress) / 10;
                    updateCleanProgress(cleanProgress, 'Processing...');
                } else {
                    clearInterval(cleanInterval);
                }
            }, 400);
        }, 1500);
        
        // Simulate model training progress if checkbox is checked
        if (trainModelCheckbox.checked) {
            setTimeout(() => {
                updateTrainProgress(0, 'Starting...');
                document.getElementById('step-train').classList.add('bg-info', 'text-white');
                
                trainInterval = setInterval(() => {
                    if (trainProgress < 90) {
                        trainProgress += (90 - trainProgress) / 15;
                        updateTrainProgress(trainProgress, 'Training...');
                    } else {
                        clearInterval(trainInterval);
                    }
                }, 500);
            }, 3000);
        }
        
        // Overall progress updates
        overallInterval = setInterval(() => {
            const progressValues = [uploadProgress];
            if (cleanProgress > 0) progressValues.push(cleanProgress);
            if (trainProgress > 0 && trainModelCheckbox.checked) progressValues.push(trainProgress);
            
            // Calculate weighted average based on what steps are active
            const weightedSum = progressValues.reduce((acc, val) => acc + val, 0);
            const newOverall = weightedSum / progressValues.length;
            
            updateOverallProgress(newOverall);
            
            if (newOverall >= 90) {
                clearInterval(overallInterval);
            }
        }, 300);
    }
    
    // Update progress UI elements
    function updateUploadProgress(percent, statusText) {
        percent = Math.min(Math.max(0, percent), 100);
        uploadProgressBar.style.width = `${percent}%`;
        uploadProgressBar.setAttribute('aria-valuenow', percent);
        uploadStatus.textContent = statusText;
        
        // Update card appearance based on progress
        const uploadCard = document.getElementById('step-upload');
        uploadCard.classList.remove('bg-secondary', 'bg-success');
        
        if (percent === 0) {
            uploadCard.classList.remove('bg-info', 'text-white');
        } else if (percent < 100) {
            uploadCard.classList.add('bg-info', 'text-white');
        } else {
            uploadCard.classList.remove('bg-info');
            uploadCard.classList.add('bg-success', 'text-white');
        }
    }
    
    function updateCleanProgress(percent, statusText) {
        percent = Math.min(Math.max(0, percent), 100);
        cleanProgressBar.style.width = `${percent}%`;
        cleanProgressBar.setAttribute('aria-valuenow', percent);
        cleanStatus.textContent = statusText;
        
        // Update card appearance based on progress
        const cleanCard = document.getElementById('step-clean');
        cleanCard.classList.remove('bg-secondary', 'bg-success');
        
        if (percent === 0) {
            cleanCard.classList.remove('bg-info', 'text-white');
        } else if (percent < 100) {
            cleanCard.classList.add('bg-info', 'text-white');
        } else if (statusText === 'Skipped') {
            cleanCard.classList.remove('bg-info');
            cleanCard.classList.add('bg-secondary', 'text-white');
        } else {
            cleanCard.classList.remove('bg-info');
            cleanCard.classList.add('bg-success', 'text-white');
        }
    }
    
    function updateTrainProgress(percent, statusText) {
        percent = Math.min(Math.max(0, percent), 100);
        trainProgressBar.style.width = `${percent}%`;
        trainProgressBar.setAttribute('aria-valuenow', percent);
        trainStatus.textContent = statusText;
        
        // Update card appearance based on progress
        const trainCard = document.getElementById('step-train');
        trainCard.classList.remove('bg-secondary', 'bg-success');
        
        if (percent === 0 && statusText === 'Skipped') {
            trainCard.classList.remove('bg-info');
            trainCard.classList.add('bg-secondary', 'text-white');
        } else if (percent === 0) {
            trainCard.classList.remove('bg-info', 'text-white');
        } else if (percent < 100) {
            trainCard.classList.add('bg-info', 'text-white');
        } else {
            trainCard.classList.remove('bg-info');
            trainCard.classList.add('bg-success', 'text-white');
        }
    }
    
    function updateOverallProgress(percent) {
        percent = Math.min(Math.max(0, percent), 100);
        const roundedPercent = Math.round(percent);
        overallProgress.style.width = `${percent}%`;
        overallProgress.setAttribute('aria-valuenow', percent);
        overallProgress.textContent = `${roundedPercent}%`;
    }
    
    // Show progress UI
    function showProgressUI() {
        uploadBtn.disabled = true;
        progressContainer.classList.remove('d-none');
        resultContainer.classList.add('d-none');
        
        // Start with upload step active
        document.getElementById('step-upload').classList.add('bg-info', 'text-white');
        uploadStatus.textContent = 'Uploading...';
    }
    
    // Show success result
    function showUploadSuccess(data, uploadTime) {
        progressContainer.classList.add('d-none');
        resultContainer.classList.remove('d-none');
        
        // Update result container styling
        const resultCard = resultContainer.querySelector('.card');
        resultCard.classList.remove('border-danger');
        resultCard.classList.add('border-success');
        
        // Update result content
        resultIcon.classList.remove('fa-times-circle', 'text-danger');
        resultIcon.classList.add('fa-check-circle', 'text-success');
        resultTitle.textContent = 'Success';
        resultMessage.textContent = data.message || 'CSV file processed successfully';
        
        // Update metrics
        recordsProcessed.textContent = data.record_count || data.records || '0';
        processingTime.textContent = uploadTime;
        
        modelAccuracy.textContent = data.model_trained ? 
            `${(data.accuracy * 100).toFixed(1)}%` : 'N/A';
        
        // Update insights
        if (data.insights && Array.isArray(data.insights) && data.insights.length > 0) {
            insightsList.innerHTML = '';
            data.insights.forEach(insight => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = insight;
                insightsList.appendChild(li);
            });
            insightsContainer.style.display = 'block';
        } else {
            insightsContainer.style.display = 'none';
        }
        
        // Enable view data button if we have upload ID
        if (data.upload_id) {
            document.getElementById('view-data-button').disabled = false;
        } else {
            document.getElementById('view-data-button').disabled = true;
        }
    }
    
    // Show error result
    function showUploadError(data) {
        progressContainer.classList.add('d-none');
        resultContainer.classList.remove('d-none');
        
        // Update result container styling
        const resultCard = resultContainer.querySelector('.card');
        resultCard.classList.remove('border-success');
        resultCard.classList.add('border-danger');
        
        // Update result content
        resultIcon.classList.remove('fa-check-circle', 'text-success');
        resultIcon.classList.add('fa-times-circle', 'text-danger');
        resultTitle.textContent = 'Error';
        resultMessage.textContent = data.message || data.error || 'An unknown error occurred';
        
        // Hide insights
        insightsContainer.style.display = 'none';
        
        // Disable view data button
        document.getElementById('view-data-button').disabled = true;
        
        // Reset metrics
        recordsProcessed.textContent = '0';
        processingTime.textContent = '—';
        modelAccuracy.textContent = 'N/A';
    }
    
    // Show a notification toast
    function showNotification(message, type) {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'position-fixed bottom-0 right-0 p-3';
            toastContainer.style.zIndex = '1050';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.className = `toast bg-${type} text-white`;
        toast.id = toastId;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.setAttribute('data-delay', '5000');
        
        toast.innerHTML = `
            <div class="toast-header bg-${type} text-white">
                <strong class="mr-auto">Notification</strong>
                <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        // Add toast to container
        toastContainer.appendChild(toast);
        
        // Initialize and show toast
        const toastElement = new bootstrap.Toast(toast);
        toastElement.show();
        
        // Remove after hiding
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
    
    // Update stats cards
    function updateStats(data) {
        if (data.total_records !== undefined) {
            document.getElementById('total-records').textContent = data.total_records;
        }
        
        if (data.model_count !== undefined) {
            document.getElementById('model-count').textContent = data.model_count;
        }
        
        if (data.best_accuracy !== undefined) {
            document.getElementById('best-accuracy').textContent = data.best_accuracy;
        }
        
        if (data.last_upload !== undefined) {
            document.getElementById('last-upload').textContent = data.last_upload;
        }
    }
    
    // Fetch latest stats
    function fetchLatestStats() {
        fetch(API.history, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(handleResponse)
        .then(data => {
            if (data.status === 'success' && data.stats) {
                updateStats(data.stats);
            }
        })
        .catch(error => {
            console.error('Error fetching stats:', error);
        });
    }
    
    // Refresh upload history table
    function refreshUploadHistory() {
        fetch(API.history, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(handleResponse)
        .then(data => {
            if (data.status === 'success') {
                dataTable.clear();
                
                if (data.history?.length) {
                    data.history.forEach(upload => {
                        dataTable.row.add([
                            upload.filename,
                            upload.record_count,
                            getStatusBadge(upload.status),
                            upload.created_at,
                            getActionButtons(upload.id)
                        ]);
                    });
                }
                
                dataTable.draw();
            }
        })
        .catch(error => {
            console.error('Error refreshing history:', error);
        });
    }
    
    // Generate status badge HTML
    function getStatusBadge(status) {
        const badgeClass = status === 'completed' ? 'success' : 
                          status === 'failed' ? 'danger' : 'warning';
        return `<span class="badge badge-${badgeClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
    }
    
    // Generate action buttons HTML
    function getActionButtons(id) {
        const viewUrl = API.viewData.replace('0', id);
        return `
            <a href="${viewUrl}" class="btn btn-sm btn-info">
                <i class="fas fa-eye"></i> View
            </a>
            <button class="btn btn-sm btn-danger delete-upload" data-id="${id}">
                <i class="fas fa-trash"></i>
            </button>
        `;
    }
    
    // Initialize the page
    refreshUploadHistory();
});
</script>
{% endblock %} 