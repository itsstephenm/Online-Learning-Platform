{% extends 'quiz/adminbase.html' %}
{% load static %}

{% block styles %}
<style>
    .step-icon {
        transition: transform 0.3s ease;
    }
    .step-active .step-icon {
        transform: scale(1.1);
    }
    .card {
        transition: all 0.3s ease;
    }
    .progress-bar-step {
        height: 6px;
        transition: width 0.5s ease;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    .pulse-animation {
        animation: pulse 1.5s infinite;
    }
</style>
{% endblock %}

{% block content %}

<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <h2 class="mb-4">AI Adoption Data Management</h2>
      
      <!-- Action Buttons -->
      <div class="mb-4">
        <a href="{% url 'ai_model_metrics' %}" class="btn btn-primary mr-2" id="model-metrics-btn">
          <i class="fas fa-chart-line"></i> Model Metrics
        </a>
        <a href="{% url 'ai_prediction_form' %}" class="btn btn-success mr-2" id="make-prediction-btn">
          <i class="fas fa-brain"></i> Make Prediction
        </a>
        <a href="{% url 'ai_view_data_list' %}" class="btn btn-info mr-2" id="view-data-btn">
          <i class="fas fa-table"></i> View All Data
        </a>
        <button id="train-existing-data" name="train-existing-data" class="btn btn-warning">
          <i class="fas fa-cogs"></i> Train Model on Existing Data
        </button>
        <form method="post" action="{% url 'train_model_view' %}" class="d-inline" id="direct-train-form">
          {% csrf_token %}
          <input type="hidden" name="algorithm" id="algorithm" value="random_forest">
          <button type="submit" class="btn btn-outline-warning" id="direct-train-btn" name="direct-train-btn">
            <i class="fas fa-cogs"></i> Direct Train (No AJAX)
          </button>
        </form>
      </div>
      
      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white" id="total-records-card">
            <div class="card-body">
              <h5 class="card-title">Total Records</h5>
              <h2 id="total-records">{{ total_records }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white" id="model-count-card">
            <div class="card-body">
              <h5 class="card-title">Models</h5>
              <h2 id="model-count">{{ model_count }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white" id="best-accuracy-card">
            <div class="card-body">
              <h5 class="card-title">Best Accuracy</h5>
              <h2 id="best-accuracy">{{ best_accuracy }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white" id="last-upload-card">
            <div class="card-body">
              <h5 class="card-title">Last Upload</h5>
              <h2 id="last-upload">{{ last_upload }}</h2>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Upload Form -->
      <div class="card mb-4" id="upload-form-card">
        <div class="card-header">
          <h5>Upload Survey Data</h5>
        </div>
        <div class="card-body">
          <form id="uploadForm" name="uploadForm" method="post" enctype="multipart/form-data" action="{% url 'upload_csv_view' %}">
            {% csrf_token %}
            <div class="custom-file mb-3">
              <input type="file" class="custom-file-input" id="csv-file" name="csv_file" required accept=".csv">
              <label class="custom-file-label" for="csv-file">Choose CSV file</label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="clean-data" name="clean_data" checked>
              <label class="form-check-label" for="clean-data">
                Clean and standardize data
              </label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="train-model" name="train_model" checked>
              <label class="form-check-label" for="train-model">
                Train model after upload
              </label>
            </div>
            <button type="submit" class="btn btn-primary" id="upload-btn" name="upload-btn">
              <i class="fas fa-upload"></i> Upload
            </button>
            <button type="submit" class="btn btn-outline-secondary ml-2" id="direct-upload-btn" name="direct-upload-btn" formnovalidate>
              <i class="fas fa-upload"></i> Direct Upload (No AJAX)
            </button>
          </form>
          
          <div id="upload-progress" class="mt-3 d-none">
            <div class="progress mb-2">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
            </div>
            <p class="mt-2 text-center" id="progress-message">Uploading file, please wait...</p>
          </div>
          
          <!-- Enhanced Multi-step Progress Indicator -->
          <div id="processing-steps" class="mt-3 d-none">
            <div class="row">
              <div class="col-md-4">
                <div class="card mb-2" id="step-upload">
                  <div class="card-body p-2 text-center">
                    <div class="step-icon">
                      <i class="fas fa-upload fa-lg mb-2"></i>
                    </div>
                    <h6 class="mb-0">Upload</h6>
                    <div class="step-status">
                      <small class="text-muted" id="upload-status">In progress...</small>
                      <div class="spinner-border spinner-border-sm text-primary d-none" id="upload-spinner" role="status">
                        <span class="sr-only">Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card mb-2" id="step-clean">
                  <div class="card-body p-2 text-center">
                    <div class="step-icon">
                      <i class="fas fa-broom fa-lg mb-2"></i>
                    </div>
                    <h6 class="mb-0">Clean Data</h6>
                    <div class="step-status">
                      <small class="text-muted" id="clean-status">Waiting...</small>
                      <div class="spinner-border spinner-border-sm text-primary d-none" id="clean-spinner" role="status">
                        <span class="sr-only">Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card mb-2" id="step-train">
                  <div class="card-body p-2 text-center">
                    <div class="step-icon">
                      <i class="fas fa-cogs fa-lg mb-2"></i>
                    </div>
                    <h6 class="mb-0">Train Model</h6>
                    <div class="step-status">
                      <small class="text-muted" id="train-status">Waiting...</small>
                      <div class="spinner-border spinner-border-sm text-primary d-none" id="train-spinner" role="status">
                        <span class="sr-only">Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Upload Result -->
          <div id="upload-result" class="mt-3 d-none">
            <div class="alert alert-success">
              <div class="d-flex align-items-center">
                <i class="fas fa-check-circle fa-2x mr-3" id="result-icon"></i>
                <div>
                  <p class="mb-1"><strong>Success!</strong> <span id="result-message"></span></p>
                  <ul id="insights-list"></ul>
                </div>
              </div>
              <div id="insights-container" class="mt-2">
                <p class="mb-1"><strong>Key Insights:</strong></p>
                <ul id="insights-list"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Upload History -->
      <div class="card">
        <div class="card-header">
          <h5>Upload History</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="upload-history-table">
              <thead>
                <tr>
                  <th id="col-filename">Filename</th>
                  <th id="col-records">Records</th>
                  <th id="col-status">Status</th>
                  <th id="col-date">Date</th>
                  <th id="col-actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for upload in upload_history %}
                <tr id="upload-row-{{ upload.id }}">
                  <td>{{ upload.original_filename }}</td>
                  <td>{{ upload.record_count }}</td>
                  <td>
                    <span class="badge badge-{% if upload.status == 'completed' %}success{% elif upload.status == 'failed' %}danger{% else %}warning{% endif %}" id="status-badge-{{ upload.id }}">
                      {{ upload.status|title }}
                    </span>
                  </td>
                  <td>{{ upload.created_at|date:"M d, Y H:i" }}</td>
                  <td>
                    <a href="{% url 'ai_data_detail' upload.id %}" class="btn btn-sm btn-info" id="view-btn-{{ upload.id }}">
                      <i class="fas fa-eye"></i> View
                    </a>
                    <button class="btn btn-sm btn-danger delete-upload" data-id="{{ upload.id }}" id="delete-btn-{{ upload.id }}">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
                {% empty %}
                <tr id="no-uploads-row">
                  <td colspan="5" class="text-center">No uploads yet</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="close-modal-x">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this upload? This will remove all data records associated with this upload.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancel-delete-btn">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDelete" name="confirmDelete">Delete</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Add DataTables CSS and JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css">
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script>

<!-- Add confetti.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" integrity="sha256-QxZX8UEW1ZvLTEvqZYEV+D6qP7YyxYcZFj+6n2Cm/w=" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTables
    const dataTable = new DataTable('#upload-history-table', {
        order: [[3, 'desc']], // Sort by date column descending
        language: {
            emptyTable: 'No uploads yet'
        }
    });

    // Define URLs using data attributes
    const uploadForm = document.getElementById('uploadForm');
    const urls = {
        uploadCsv: uploadForm.action,
        trainModel: document.getElementById('direct-train-form').action,
        uploadHistory: "{% url 'upload_history' %}",
        deleteBase: "{% url 'delete_upload' 0 %}"
    };

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // File input change handler
    document.getElementById('csv-file').addEventListener('change', function(e) {
        const fileName = e.target.value.split('\\').pop();
        e.target.nextElementSibling.textContent = fileName;
    });

    // Form submission handler
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Reset UI state
        resetUIState();
        
        // Show progress indicators
        showProgressIndicators();
        
        // Send form data
        const formData = new FormData(this);
        formData.set('clean_data', document.getElementById('clean-data').checked.toString());
        formData.set('train_model', document.getElementById('train-model').checked.toString());
        
        fetch(urls.uploadCsv, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showFinalResult(data);
            } else {
                showError(data);
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showError({message: 'Error: ' + error.message});
        })
        .finally(() => {
            document.getElementById('upload-btn').disabled = false;
        });
    });

    // Helper functions
    function resetUIState() {
        const elements = ['step-upload', 'step-clean', 'step-train'].map(id => document.getElementById(id));
        elements.forEach(el => {
            el.classList.remove('bg-info', 'bg-success', 'bg-secondary', 'text-white', 'step-active');
        });
        
        ['upload-status', 'clean-status', 'train-status'].forEach(id => {
            const el = document.getElementById(id);
            el.classList.remove('text-white');
            el.classList.add('text-muted');
            el.textContent = id === 'upload-status' ? 'In progress...' : 'Waiting...';
        });
    }

    function showProgressIndicators() {
        document.getElementById('upload-btn').disabled = true;
        document.getElementById('upload-progress').classList.remove('d-none');
        document.getElementById('processing-steps').classList.remove('d-none');
        document.getElementById('upload-result').classList.add('d-none');
        
        const uploadStep = document.getElementById('step-upload');
        uploadStep.classList.add('bg-info', 'text-white', 'step-active');
        
        const uploadStatus = document.getElementById('upload-status');
        uploadStatus.classList.remove('text-muted');
        uploadStatus.classList.add('text-white');
        
        document.getElementById('upload-spinner').classList.remove('d-none');
        document.getElementById('progress-message').textContent = 'Uploading file, please wait...';
    }

    function showFinalResult(response) {
        // Update stats
        updateStats(response);
        
        // Show success animation
        if (typeof confetti === 'function') {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }
        
        // Update UI
        const resultDiv = document.getElementById('upload-result');
        resultDiv.classList.remove('d-none');
        resultDiv.querySelector('.alert').classList.remove('alert-danger');
        resultDiv.querySelector('.alert').classList.add('alert-success');
        
        document.getElementById('result-icon').classList.remove('fa-times-circle', 'text-danger');
        document.getElementById('result-icon').classList.add('fa-check-circle', 'text-success');
        document.getElementById('result-message').textContent = 'CSV file processed successfully.';
        document.getElementById('records-processed').textContent = response.records;
        document.getElementById('processing-time').textContent = response.processing_time.toFixed(2);
        document.getElementById('model-accuracy').textContent = response.model_trained ? 
            (response.accuracy * 100).toFixed(2) + '%' : 'N/A (No model trained)';
        
        // Show insights
        const insightsContainer = document.getElementById('insights-container');
        const insightsList = document.getElementById('insights-list');
        
        if (response.insights?.length) {
            insightsList.innerHTML = '';
            response.insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                insightsList.appendChild(li);
            });
            insightsContainer.style.display = 'block';
        } else {
            insightsContainer.style.display = 'none';
        }
        
        // Reset form
        uploadForm.reset();
        document.querySelector('.custom-file-label').textContent = 'Choose CSV file';
        refreshUploadHistory();
    }

    function showError(response) {
        document.getElementById('upload-progress').classList.add('d-none');
        document.getElementById('processing-steps').classList.add('d-none');
        
        const resultDiv = document.getElementById('upload-result');
        resultDiv.classList.remove('d-none');
        resultDiv.querySelector('.alert').classList.remove('alert-success');
        resultDiv.querySelector('.alert').classList.add('alert-danger');
        
        const resultIcon = document.getElementById('result-icon');
        resultIcon.classList.remove('fa-check-circle', 'text-success');
        resultIcon.classList.add('fa-times-circle', 'text-danger');
        
        const errorMsg = response.message || response.error || 'Unknown error occurred';
        document.getElementById('result-message').textContent = 'Error: ' + errorMsg;
        document.getElementById('insights-container').style.display = 'none';
        console.error('Error details:', response);
    }

    function updateStats(response) {
        document.getElementById('total-records').textContent = response.total_records;
        document.getElementById('model-count').textContent = response.model_count;
        document.getElementById('best-accuracy').textContent = response.best_accuracy;
        document.getElementById('last-upload').textContent = response.last_upload;
    }

    function refreshUploadHistory() {
        fetch(urls.uploadHistory, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                dataTable.clear();
                
                if (data.history?.length) {
                    data.history.forEach(upload => {
                        const statusBadge = getStatusBadge(upload.status);
                        const viewUrl = "{% url 'ai_data_detail' 0 %}".replace('0', upload.id);
                        
                        dataTable.row.add([
                            upload.filename,
                            upload.record_count,
                            statusBadge,
                            upload.created_at,
                            getActionButtons(upload.id, viewUrl)
                        ]);
                    });
                }
                
                dataTable.draw();
            }
        });
    }

    function getStatusBadge(status) {
        const badgeClass = status === 'completed' ? 'success' : 
                          status === 'failed' ? 'danger' : 'warning';
        return `<span class="badge badge-${badgeClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
    }

    function getActionButtons(id, viewUrl) {
        return `
            <a href="${viewUrl}" class="btn btn-sm btn-info">
                <i class="fas fa-eye"></i> View
            </a>
            <button class="btn btn-sm btn-danger delete-upload" data-id="${id}">
                <i class="fas fa-trash"></i>
            </button>
        `;
    }

    // Delete functionality
    let deleteUploadId = null;
    
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-upload')) {
            deleteUploadId = e.target.closest('.delete-upload').dataset.id;
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }
    });

    document.getElementById('confirmDelete').addEventListener('click', function() {
        if (!deleteUploadId) return;
        
        const deleteUrl = urls.deleteBase.replace('0', deleteUploadId);
        
        fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                refreshUploadHistory();
                updateStats(data);
            } else {
                alert('Error deleting upload: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            alert('Error deleting upload: ' + error.message);
        });
        
        bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
    });

    // Direct upload button handler
    document.getElementById('direct-upload-btn').addEventListener('click', function() {
        uploadForm.removeEventListener('submit', arguments.callee);
    });
});
</script>
{% endblock %} 