{% extends 'teacher/teacherbase.html' %}
{% load static %}

{% block title %}Make Prediction{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Make AI Prediction</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'quiz:ai_dashboard' %}">AI Dashboard</a></li>
        <li class="breadcrumb-item active">Make Prediction</li>
    </ol>

    {% if messages %}
    <div class="row mb-4">
        <div class="col-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        {% if prediction_result %}
        <!-- Prediction Result -->
        <div class="col-12 mb-4">
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="m-0">Prediction Result</h5>
                    <a href="{% url 'quiz:make_new_prediction' %}" class="btn btn-sm btn-light">
                        <i class="fas fa-redo me-1"></i>New Prediction
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h4 class="mb-3">
                                Student has a 
                                {% if prediction_result.prediction_class == 1 %}
                                <span class="text-success">{{ prediction_result.success_probability|floatformat:1 }}% chance of success</span>
                                {% else %}
                                <span class="text-danger">{{ prediction_result.risk_probability|floatformat:1 }}% chance of risk</span>
                                {% endif %}
                            </h4>
                            
                            <div class="progress mb-4" style="height: 30px;">
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     style="width: {{ prediction_result.success_probability }}%;" 
                                     aria-valuenow="{{ prediction_result.success_probability }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ prediction_result.success_probability|floatformat:1 }}%
                                </div>
                                <div class="progress-bar bg-danger" 
                                     role="progressbar" 
                                     style="width: {{ prediction_result.risk_probability }}%;" 
                                     aria-valuenow="{{ prediction_result.risk_probability }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ prediction_result.risk_probability|floatformat:1 }}%
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card border-left-success h-100">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                        Success Probability
                                                    </div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                        {{ prediction_result.success_probability|floatformat:1 }}%
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-check-circle fa-2x text-success"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-left-danger h-100">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                                        Risk Probability
                                                    </div>
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                        {{ prediction_result.risk_probability|floatformat:1 }}%
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h5>Key Factors</h5>
                                <div id="featureImportanceChart" style="height: 300px;"></div>
                                <div class="small text-muted mt-2">Features with higher values have more influence on the prediction outcome.</div>
                            </div>
                            
                            <h5>Input Data</h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Feature</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for feature, value in prediction_result.input_data.items %}
                                        <tr>
                                            <td>{{ feature }}</td>
                                            <td>{{ value }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-robot me-1"></i>
                                    Model Information
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="fw-bold d-block">Model Used</label>
                                        <span>{{ prediction_result.model_name }}</span>
                                    </div>
                                    <div class="mb-3">
                                        <label class="fw-bold d-block">Model Accuracy</label>
                                        <span>{{ prediction_result.model_accuracy|floatformat:2 }}%</span>
                                    </div>
                                    <div class="mb-3">
                                        <label class="fw-bold d-block">Last Trained</label>
                                        <span>{{ prediction_result.last_trained }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Recommended Actions
                                </div>
                                <div class="card-body">
                                    {% if prediction_result.prediction_class == 1 %}
                                    <div class="alert alert-success mb-3">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>Success Likely</strong>
                                    </div>
                                    <p>This student shows a strong likelihood of success. Consider:</p>
                                    <ul>
                                        <li>Regular check-ins to maintain progress</li>
                                        <li>Providing advanced materials to keep them engaged</li>
                                        <li>Encouraging peer tutoring opportunities</li>
                                    </ul>
                                    {% else %}
                                    <div class="alert alert-warning mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Intervention Recommended</strong>
                                    </div>
                                    <p>This student may need additional support. Consider:</p>
                                    <ul>
                                        <li>Early intervention with additional tutoring</li>
                                        <li>More frequent assessment to track progress</li>
                                        <li>Personalized learning plan to address gaps</li>
                                        <li>Reach out for a one-on-one meeting</li>
                                    </ul>
                                    {% endif %}
                                    
                                    <a href="#" class="btn btn-primary d-block">
                                        <i class="fas fa-file-alt me-1"></i>
                                        Generate Detailed Report
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#shareModal">
                            <i class="fas fa-share-alt me-1"></i>Share
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Make Prediction Form -->
        <div class="col-xl-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-brain me-1"></i>
                        Make Prediction
                    </div>
                </div>
                <div class="card-body">
                    <form id="predictionForm" method="post" action="{% url 'quiz:make_new_prediction' %}">
                        {% csrf_token %}

                        <div class="mb-4">
                            <label for="model_id" class="form-label">Select Model</label>
                            <select class="form-select" id="model_id" name="model_id" required>
                                <option value="">Choose an AI model...</option>
                                {% for model in available_models %}
                                <option value="{{ model.id }}">{{ model.name }} ({{ model.accuracy|floatformat:2 }}% accuracy)</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select the model to use for making the prediction.</div>
                        </div>

                        <div class="mb-4">
                            <label for="student_id" class="form-label">Student</label>
                            <select class="form-select" id="student_id" name="student_id">
                                <option value="">Select a student...</option>
                                {% for student in students %}
                                <option value="{{ student.id }}">{{ student.user.first_name }} {{ student.user.last_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select an existing student or enter manual data below.</div>
                        </div>

                        <hr class="my-4">
                        <h5 class="mb-3">Student Data</h5>
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <span>You can either select a student above or manually enter student data below.</span>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="prev_score" class="form-label">Previous Score</label>
                                    <input type="number" class="form-control" id="prev_score" name="prev_score" 
                                           min="0" max="100" step="0.1" placeholder="e.g., 75.5">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="attendance_rate" class="form-label">Attendance Rate (%)</label>
                                    <input type="number" class="form-control" id="attendance_rate" name="attendance_rate" 
                                           min="0" max="100" step="0.1" placeholder="e.g., 85.0">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="quiz_completion" class="form-label">Quiz Completion (%)</label>
                                    <input type="number" class="form-control" id="quiz_completion" name="quiz_completion" 
                                           min="0" max="100" step="0.1" placeholder="e.g., 90.0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="time_spent" class="form-label">Time Spent (hours)</label>
                                    <input type="number" class="form-control" id="time_spent" name="time_spent" 
                                           min="0" step="0.1" placeholder="e.g., 25.5">
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="age" class="form-label">Age</label>
                                    <input type="number" class="form-control" id="age" name="age" 
                                           min="1" max="100" step="1" placeholder="e.g., 20">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="gender" class="form-label">Gender</label>
                                    <select class="form-select" id="gender" name="gender">
                                        <option value="">Select gender...</option>
                                        <option value="M">Male</option>
                                        <option value="F">Female</option>
                                        <option value="O">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" id="predictBtn">
                                <i class="fas fa-brain me-2"></i>Generate Prediction
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-lightbulb me-1"></i>
                    About AI Predictions
                </div>
                <div class="card-body">
                    <h5 class="card-title">How it works</h5>
                    <p>Our AI prediction system analyzes student data to predict their likelihood of success in courses or exams. The system uses machine learning algorithms trained on historical student data.</p>
                    
                    <div class="mb-3">
                        <h6 class="fw-bold">The prediction process:</h6>
                        <ol class="small">
                            <li>Select a trained AI model</li>
                            <li>Input student data (either select a student or enter data manually)</li>
                            <li>The AI analyzes the data based on patterns it learned from previous students</li>
                            <li>View the prediction results and recommended actions</li>
                        </ol>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> AI predictions are tools to assist educators, not replace their judgment. Always consider the full context of each student's situation.
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{% url 'quiz:upload_training_data' %}" class="btn btn-outline-primary">
                            <i class="fas fa-upload me-1"></i>
                            Upload Training Data
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shareModalLabel">Share Prediction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="shareEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="shareEmail" placeholder="Enter recipient's email">
                    </div>
                    <div class="mb-3">
                        <label for="shareMessage" class="form-label">Message (Optional)</label>
                        <textarea class="form-control" id="shareMessage" rows="3" placeholder="Add a personal message"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if prediction_result %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    $(document).ready(function() {
        // Highlight the AI Dashboard nav item
        $("#aiDashboardNav").addClass("active");
        
        // Feature importance chart
        const featureImportance = {{ prediction_result.feature_importance|safe }};
        const featureLabels = Object.keys(featureImportance);
        const featureValues = Object.values(featureImportance);
        
        // Sort by importance (descending)
        const combined = featureLabels.map((label, i) => {
            return { label: label, value: featureValues[i] };
        });
        combined.sort((a, b) => b.value - a.value);
        
        const sortedLabels = combined.map(item => item.label);
        const sortedValues = combined.map(item => item.value);
        
        const options = {
            series: [{
                name: 'Importance',
                data: sortedValues
            }],
            chart: {
                type: 'bar',
                height: 300,
                toolbar: {
                    show: false
                }
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    dataLabels: {
                        position: 'top',
                    },
                }
            },
            colors: ['#4e73df'],
            dataLabels: {
                enabled: true,
                formatter: function(val) {
                    return val.toFixed(2);
                },
                offsetX: 20,
                style: {
                    fontSize: '12px',
                    colors: ['#304758']
                }
            },
            xaxis: {
                categories: sortedLabels.map(label => label.replace('_', ' ')),
                labels: {
                    formatter: function(val) {
                        return val.toFixed(2);
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function(val) {
                        return val.toFixed(2);
                    }
                }
            }
        };
        
        const chart = new ApexCharts(document.querySelector("#featureImportanceChart"), options);
        chart.render();
    });
</script>
{% else %}
<script>
    $(document).ready(function() {
        // Highlight the AI Dashboard nav item
        $("#aiDashboardNav").addClass("active");
        
        // Student selection handling
        $("#student_id").on("change", function() {
            const studentId = $(this).val();
            if (studentId) {
                // Disable manual inputs if student is selected
                $("#prev_score, #attendance_rate, #quiz_completion, #time_spent, #age, #gender").prop("disabled", true);
                
                // Fetch student data via AJAX
                $.ajax({
                    url: `/api/student/${studentId}/data/`,
                    method: 'GET',
                    success: function(data) {
                        // Populate form with student data
                        $("#prev_score").val(data.prev_score);
                        $("#attendance_rate").val(data.attendance_rate);
                        $("#quiz_completion").val(data.quiz_completion);
                        $("#time_spent").val(data.time_spent);
                        $("#age").val(data.age);
                        $("#gender").val(data.gender);
                    },
                    error: function(xhr) {
                        console.error("Error fetching student data:", xhr);
                        alert("Could not fetch student data. Please try again or enter data manually.");
                        $("#student_id").val("");
                        $("#prev_score, #attendance_rate, #quiz_completion, #time_spent, #age, #gender")
                            .prop("disabled", false)
                            .val("");
                    }
                });
            } else {
                // Enable manual inputs if no student is selected
                $("#prev_score, #attendance_rate, #quiz_completion, #time_spent, #age, #gender")
                    .prop("disabled", false)
                    .val("");
            }
        });
        
        // Form validation
        $("#predictionForm").on("submit", function(e) {
            const studentId = $("#student_id").val();
            const prevScore = $("#prev_score").val();
            const attendanceRate = $("#attendance_rate").val();
            const quizCompletion = $("#quiz_completion").val();
            
            // If no student selected, require minimum manual inputs
            if (!studentId && (!prevScore || !attendanceRate || !quizCompletion)) {
                e.preventDefault();
                alert("Please select a student or provide at least Previous Score, Attendance Rate, and Quiz Completion.");
                return;
            }
            
            // Show loading state
            $("#predictBtn").prop("disabled", true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');
        });
    });
</script>
{% endif %}
{% endblock %} 