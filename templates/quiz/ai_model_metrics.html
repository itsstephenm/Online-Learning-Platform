{% extends 'quiz/adminbase.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <h2 class="mb-4">AI Adoption Model Metrics</h2>
      
      <!-- Model Overview Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <h5 class="card-title">Active Model</h5>
              <h2 id="active-model">{{ active_model|default:"None" }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body">
              <h5 class="card-title">Accuracy</h5>
              <h2 id="model-accuracy">{{ accuracy|floatformat:2 }}%</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body">
              <h5 class="card-title">F1 Score</h5>
              <h2 id="f1-score">{{ f1_score|floatformat:2 }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <h5 class="card-title">Training Date</h5>
              <h2 id="training-date">{{ training_date|date:"M d, Y" }}</h2>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Model Selection and Controls -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between">
          <h5>Model Management</h5>
          <button class="btn btn-primary" id="train-new-model">
            <i class="fas fa-cogs"></i> Train New Model
          </button>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <div class="table-responsive">
                <table class="table table-striped" id="models-table">
                  <thead>
                    <tr>
                      <th>Model ID</th>
                      <th>Type</th>
                      <th>Accuracy</th>
                      <th>F1 Score</th>
                      <th>Training Date</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for model in models %}
                    <tr class="{% if model.is_active %}table-success{% endif %}">
                      <td>{{ model.id }}</td>
                      <td>{{ model.model_type }}</td>
                      <td>{{ model.accuracy|floatformat:2 }}%</td>
                      <td>{{ model.f1_score|floatformat:2 }}</td>
                      <td>{{ model.created_at|date:"M d, Y" }}</td>
                      <td>
                        {% if model.is_active %}
                        <span class="badge badge-success">Active</span>
                        {% else %}
                        <span class="badge badge-secondary">Inactive</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if not model.is_active %}
                        <button class="btn btn-sm btn-success activate-model" data-id="{{ model.id }}">
                          <i class="fas fa-check"></i> Activate
                        </button>
                        {% endif %}
                        <button class="btn btn-sm btn-danger delete-model" data-id="{{ model.id }}">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="7" class="text-center">No models available</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h5>Training Options</h5>
                </div>
                <div class="card-body">
                  <form id="model-training-form">
                    {% csrf_token %}
                    <div class="form-group">
                      <label for="model-type">Model Type</label>
                      <select class="form-control" id="model-type" name="model_type">
                        <option value="random_forest">Random Forest</option>
                        <option value="logistic_regression">Logistic Regression</option>
                        <option value="svm">Support Vector Machine</option>
                        <option value="gradient_boosting">Gradient Boosting</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="test-size">Test Size</label>
                      <input type="range" class="form-control-range" id="test-size" name="test_size" min="0.1" max="0.5" step="0.05" value="0.2">
                      <small class="form-text text-muted">Test size: <span id="test-size-value">0.2</span></small>
                    </div>
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" id="cross-validation" name="cross_validation" checked>
                      <label class="form-check-label" for="cross-validation">Use cross-validation</label>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Start Training</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Performance Metrics -->
      <div class="row">
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5>Confusion Matrix</h5>
            </div>
            <div class="card-body">
              <div class="confusion-matrix-container">
                <div id="confusion-matrix"></div>
                {% if confusion_matrix %}
                <div class="table-responsive confusion-matrix-table">
                  <table class="table table-bordered text-center">
                    <thead>
                      <tr>
                        <th></th>
                        <th>Predicted No</th>
                        <th>Predicted Yes</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <th>Actual No</th>
                        <td>{{ confusion_matrix.0.0 }}</td>
                        <td>{{ confusion_matrix.0.1 }}</td>
                      </tr>
                      <tr>
                        <th>Actual Yes</th>
                        <td>{{ confusion_matrix.1.0 }}</td>
                        <td>{{ confusion_matrix.1.1 }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                {% else %}
                <p class="text-center">No confusion matrix data available</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5>ROC Curve</h5>
            </div>
            <div class="card-body">
              <div id="roc-curve-container">
                {% if roc_curve_data %}
                <canvas id="roc-curve"></canvas>
                {% else %}
                <p class="text-center">No ROC curve data available</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Feature Importance -->
      <div class="card mb-4">
        <div class="card-header">
          <h5>Feature Importance</h5>
        </div>
        <div class="card-body">
          {% if feature_importance %}
          <div id="feature-importance-chart"></div>
          {% else %}
          <p class="text-center">No feature importance data available</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Training Modal -->
<div class="modal fade" id="trainingModal" tabindex="-1" role="dialog" aria-labelledby="trainingModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="trainingModalLabel">Training Model</h5>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="sr-only">Training...</span>
          </div>
          <p>Training AI model. This may take a few minutes...</p>
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirm-message"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirm-action">Confirm</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
$(document).ready(function() {
    // Update test size value display
    $('#test-size').on('input', function() {
        $('#test-size-value').text($(this).val());
    });
    
    // Toggle training options panel
    $('#train-new-model').on('click', function() {
        $('#model-training-form').closest('.card').toggle();
    });
    
    // Handle model training form submission
    $('#model-training-form').on('submit', function(e) {
        e.preventDefault();
        
        // Show training modal
        $('#trainingModal').modal({
            backdrop: 'static',
            keyboard: false
        });
        
        const formData = new FormData(this);
        
        // Send AJAX request for training
        $.ajax({
            url: '{% url "train_model_view" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#trainingModal').modal('hide');
                
                if (response.status === 'success') {
                    // Reload page to show new model
                    window.location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                $('#trainingModal').modal('hide');
                alert('Error: ' + error);
            }
        });
    });
    
    // Handle model activation
    $(document).on('click', '.activate-model', function() {
        const modelId = $(this).data('id');
        
        $('#confirm-message').text('Are you sure you want to activate this model? The currently active model will be deactivated.');
        $('#confirm-action').data('action', 'activate').data('id', modelId);
        $('#confirmModal').modal('show');
    });
    
    // Handle model deletion
    $(document).on('click', '.delete-model', function() {
        const modelId = $(this).data('id');
        const isActive = $(this).closest('tr').hasClass('table-success');
        
        if (isActive) {
            alert('You cannot delete the currently active model. Please activate another model first.');
            return;
        }
        
        $('#confirm-message').text('Are you sure you want to delete this model? This action cannot be undone.');
        $('#confirm-action').data('action', 'delete').data('id', modelId);
        $('#confirmModal').modal('show');
    });
    
    // Handle confirmation
    $('#confirm-action').on('click', function() {
        const action = $(this).data('action');
        const modelId = $(this).data('id');
        let url = '';
        
        if (action === 'activate') {
            url = '/quiz/admin/ai-adoption/activate-model/' + modelId + '/';
        } else if (action === 'delete') {
            url = '/quiz/admin/ai-adoption/delete-model/' + modelId + '/';
        }
        
        if (url) {
            $.ajax({
                url: url,
                type: 'POST',
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error: ' + error);
                }
            });
        }
        
        $('#confirmModal').modal('hide');
    });
    
    {% if confusion_matrix %}
    // Plot confusion matrix
    const confusionMatrixData = [
        {
            z: [
                [{{ confusion_matrix.0.0 }}, {{ confusion_matrix.0.1 }}],
                [{{ confusion_matrix.1.0 }}, {{ confusion_matrix.1.1 }}]
            ],
            x: ['Predicted No', 'Predicted Yes'],
            y: ['Actual No', 'Actual Yes'],
            type: 'heatmap',
            colorscale: 'Blues',
            showscale: false,
            hoverongaps: false
        }
    ];
    
    const confusionMatrixLayout = {
        title: 'Confusion Matrix',
        annotations: [
            {
                x: 0,
                y: 0,
                text: '{{ confusion_matrix.0.0 }}',
                font: { color: 'white' },
                showarrow: false
            },
            {
                x: 1,
                y: 0,
                text: '{{ confusion_matrix.0.1 }}',
                font: { color: 'white' },
                showarrow: false
            },
            {
                x: 0,
                y: 1,
                text: '{{ confusion_matrix.1.0 }}',
                font: { color: 'white' },
                showarrow: false
            },
            {
                x: 1,
                y: 1,
                text: '{{ confusion_matrix.1.1 }}',
                font: { color: 'white' },
                showarrow: false
            }
        ],
        margin: { t: 50, l: 100 }
    };
    
    Plotly.newPlot('confusion-matrix', confusionMatrixData, confusionMatrixLayout);
    {% endif %}
    
    {% if roc_curve_data %}
    // Plot ROC curve
    const ctx = document.getElementById('roc-curve').getContext('2d');
    const rocChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ roc_curve_data.fpr|safe }},
            datasets: [{
                label: 'ROC Curve (AUC = {{ roc_auc|floatformat:3 }})',
                data: {{ roc_curve_data.tpr|safe }},
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                pointRadius: 0,
                fill: true
            }, {
                label: 'Random Classifier',
                data: {{ roc_curve_data.fpr|safe }},
                borderColor: 'rgba(255, 99, 132, 0.8)',
                borderWidth: 1,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'False Positive Rate'
                    },
                    beginAtZero: true
                },
                y: {
                    title: {
                        display: true,
                        text: 'True Positive Rate'
                    },
                    beginAtZero: true
                }
            }
        }
    });
    {% endif %}
    
    {% if feature_importance %}
    // Plot feature importance
    const featureData = [
        {
            x: {{ feature_importance.values|safe }},
            y: {{ feature_importance.features|safe }},
            type: 'bar',
            orientation: 'h',
            marker: {
                color: 'rgba(50, 171, 96, 0.7)'
            }
        }
    ];
    
    const featureLayout = {
        title: 'Feature Importance',
        xaxis: {
            title: 'Importance Score'
        },
        yaxis: {
            title: 'Feature',
            automargin: true
        },
        margin: {
            l: 150
        }
    };
    
    Plotly.newPlot('feature-importance-chart', featureData, featureLayout);
    {% endif %}
});
</script>
{% endblock %} 