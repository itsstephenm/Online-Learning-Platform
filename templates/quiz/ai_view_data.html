{% extends 'quiz/adminbase.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dataset: {{ dataset.original_filename }}</h2>
        <div>
          <a href="{% url 'ai_upload_data' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Uploads
          </a>
          <button id="export-csv" class="btn btn-success">
            <i class="fas fa-file-export"></i> Export CSV
          </button>
        </div>
      </div>
      
      <!-- Dataset Info Card -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Dataset Information</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              <div class="border rounded p-3 text-center">
                <h6 class="text-muted">Records</h6>
                <h3>{{ dataset.record_count }}</h3>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="border rounded p-3 text-center">
                <h6 class="text-muted">Upload Date</h6>
                <h3>{{ dataset.created_at|date:"M d, Y" }}</h3>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="border rounded p-3 text-center">
                <h6 class="text-muted">Columns</h6>
                <h3>{{ column_count }}</h3>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="border rounded p-3 text-center">
                <h6 class="text-muted">Status</h6>
                <h3>
                  {% if dataset.status == 'success' %}
                  <span class="badge bg-success">Success</span>
                  {% elif dataset.status == 'error' %}
                  <span class="badge bg-danger">Error</span>
                  {% else %}
                  <span class="badge bg-warning">{{ dataset.status|title }}</span>
                  {% endif %}
                </h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Dataset Overview Tabs -->
      <div class="card mb-4">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="datasetTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="data-preview-tab" data-bs-toggle="tab" data-bs-target="#data-preview" type="button" role="tab" aria-selected="true">
                <i class="fas fa-table"></i> Data Preview
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="data-summary-tab" data-bs-toggle="tab" data-bs-target="#data-summary" type="button" role="tab" aria-selected="false">
                <i class="fas fa-chart-bar"></i> Data Summary
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="missing-values-tab" data-bs-toggle="tab" data-bs-target="#missing-values" type="button" role="tab" aria-selected="false">
                <i class="fas fa-exclamation-triangle"></i> Missing Values
              </button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="datasetTabContent">
            <!-- Data Preview Tab -->
            <div class="tab-pane fade show active" id="data-preview" role="tabpanel" aria-labelledby="data-preview-tab">
              <div class="table-responsive">
                <table class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      {% for column in columns %}
                      <th>{{ column }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in data_preview %}
                    <tr>
                      {% for cell in row %}
                      <td>{{ cell }}</td>
                      {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="{{ columns|length }}" class="text-center">No data available</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                  <span class="text-muted">Showing {{ data_preview|length }} of {{ dataset.record_count }} rows</span>
                </div>
                <div>
                  <button id="load-more-data" class="btn btn-outline-primary">
                    <i class="fas fa-sync"></i> Load More
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Data Summary Tab -->
            <div class="tab-pane fade" id="data-summary" role="tabpanel" aria-labelledby="data-summary-tab">
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Column</th>
                      <th>Type</th>
                      <th>Count</th>
                      <th>Unique</th>
                      <th>Missing</th>
                      {% if has_numeric_columns %}
                      <th>Mean</th>
                      <th>Min</th>
                      <th>Max</th>
                      {% endif %}
                      {% if has_categorical_columns %}
                      <th>Most Common</th>
                      {% endif %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for column in column_stats %}
                    <tr>
                      <td>{{ column.name }}</td>
                      <td>{{ column.dtype }}</td>
                      <td>{{ column.count }}</td>
                      <td>{{ column.unique }}</td>
                      <td>{{ column.missing }} ({{ column.missing_pct }}%)</td>
                      {% if column.is_numeric %}
                      <td>{{ column.mean|floatformat:2 }}</td>
                      <td>{{ column.min }}</td>
                      <td>{{ column.max }}</td>
                      {% endif %}
                      {% if column.is_categorical %}
                      <td>{{ column.most_common }} ({{ column.most_common_count }})</td>
                      {% endif %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Missing Values Tab -->
            <div class="tab-pane fade" id="missing-values" role="tabpanel" aria-labelledby="missing-values-tab">
              <div class="row">
                <div class="col-md-8">
                  <canvas id="missing-values-chart" height="300"></canvas>
                </div>
                <div class="col-md-4">
                  <div class="card h-100">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">Missing Values Summary</h6>
                    </div>
                    <div class="card-body">
                      <ul class="list-group list-group-flush">
                        {% for column in missing_values %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          {{ column.name }}
                          <span class="badge bg-secondary rounded-pill">{{ column.missing_pct }}%</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item">No missing values found</li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Data Visualizations -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Data Visualizations</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <!-- Visualization Controls -->
            <div class="col-md-3">
              <div class="card h-100">
                <div class="card-header bg-light">
                  <h6 class="mb-0">Configure Chart</h6>
                </div>
                <div class="card-body">
                  <form id="visualization-form">
                    <div class="mb-3">
                      <label for="chart-type" class="form-label">Chart Type</label>
                      <select class="form-select" id="chart-type">
                        <option value="bar">Bar Chart</option>
                        <option value="pie">Pie Chart</option>
                        <option value="histogram">Histogram</option>
                        <option value="scatter">Scatter Plot</option>
                      </select>
                    </div>
                    
                    <div class="mb-3">
                      <label for="x-axis" class="form-label">X-Axis</label>
                      <select class="form-select" id="x-axis">
                        {% for column in columns %}
                        <option value="{{ column }}">{{ column }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    
                    <div class="mb-3" id="y-axis-container">
                      <label for="y-axis" class="form-label">Y-Axis</label>
                      <select class="form-select" id="y-axis">
                        <option value="">None</option>
                        {% for column in columns %}
                        <option value="{{ column }}">{{ column }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    
                    <div class="mb-3">
                      <button type="button" id="generate-chart" class="btn btn-primary w-100">
                        <i class="fas fa-chart-line"></i> Generate Chart
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            
            <!-- Chart Area -->
            <div class="col-md-9">
              <div class="chart-container" style="position: relative; height: 400px;">
                <canvas id="data-visualization-chart"></canvas>
              </div>
              <div id="chart-placeholder" class="d-flex justify-content-center align-items-center h-100 border rounded bg-light">
                <div class="text-center p-4">
                  <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                  <p>Select chart options and click "Generate Chart" to visualize your data</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- AI Insights -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">AI-Generated Insights</h5>
        </div>
        <div class="card-body">
          <div id="insights-loading" class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Analyzing data to generate insights...</p>
          </div>
          
          <div id="insights-container" class="d-none">
            <div class="row" id="insights-row">
              <!-- Insights will be added here dynamically -->
            </div>
          </div>
          
          <div class="text-center mt-3">
            <button id="generate-insights" class="btn btn-outline-primary">
              <i class="fas fa-brain"></i> Generate New Insights
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
  // Initial setup
  const chartContainer = $('.chart-container');
  const chartPlaceholder = $('#chart-placeholder');
  let dataVisualizationChart = null;
  let missingValuesChart = null;
  
  // Hide chart container initially
  chartContainer.hide();
  
  // Initialize missing values chart if data exists
  {% if missing_values %}
  const missingValuesCtx = document.getElementById('missing-values-chart').getContext('2d');
  missingValuesChart = new Chart(missingValuesCtx, {
    type: 'bar',
    data: {
      labels: [{% for column in missing_values %}'{{ column.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Missing Values (%)',
        data: [{% for column in missing_values %}{{ column.missing_pct }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(220, 53, 69, 0.5)',
        borderColor: 'rgba(220, 53, 69, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        },
        title: {
          display: true,
          text: 'Missing Values by Column (%)'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Percentage (%)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Column'
          }
        }
      }
    }
  });
  {% endif %}
  
  // Handle chart type change
  $('#chart-type').on('change', function() {
    const chartType = $(this).val();
    const yAxisContainer = $('#y-axis-container');
    
    if (chartType === 'pie' || chartType === 'histogram') {
      yAxisContainer.hide();
    } else {
      yAxisContainer.show();
    }
  });
  
  // Generate chart button click
  $('#generate-chart').on('click', function() {
    const chartType = $('#chart-type').val();
    const xAxis = $('#x-axis').val();
    const yAxis = $('#y-axis').val();
    
    // Validate selection
    if (!xAxis) {
      alert('Please select at least X-axis variable');
      return;
    }
    
    if ((chartType === 'scatter' || chartType === 'bar') && !yAxis) {
      alert('Please select Y-axis variable for this chart type');
      return;
    }
    
    // Show loading indicator
    chartPlaceholder.hide();
    chartContainer.show();
    
    // Send AJAX request to generate chart data
    $.ajax({
      url: '{% url "generate_chart_view" dataset.id %}',
      type: 'POST',
      data: {
        chart_type: chartType,
        x_axis: xAxis,
        y_axis: yAxis
      },
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function(response) {
        if (response.status === 'success') {
          renderChart(response.data, chartType, xAxis, yAxis);
        } else {
          alert('Error generating chart: ' + response.message);
          chartContainer.hide();
          chartPlaceholder.show();
        }
      },
      error: function() {
        alert('Error communicating with server');
        chartContainer.hide();
        chartPlaceholder.show();
      }
    });
  });
  
  // Function to render chart based on type and data
  function renderChart(data, chartType, xLabel, yLabel) {
    // Destroy existing chart if it exists
    if (dataVisualizationChart) {
      dataVisualizationChart.destroy();
    }
    
    const ctx = document.getElementById('data-visualization-chart').getContext('2d');
    let chartConfig = {
      type: chartType,
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: getChartTitle(chartType, xLabel, yLabel)
          }
        }
      }
    };
    
    // Add specific options based on chart type
    if (chartType === 'bar' || chartType === 'scatter' || chartType === 'histogram') {
      chartConfig.options.scales = {
        x: {
          title: {
            display: true,
            text: xLabel
          }
        },
        y: {
          title: {
            display: true,
            text: yLabel || 'Count'
          },
          beginAtZero: true
        }
      };
    }
    
    dataVisualizationChart = new Chart(ctx, chartConfig);
  }
  
  // Helper function to generate chart title
  function getChartTitle(chartType, xLabel, yLabel) {
    switch(chartType) {
      case 'bar':
        return yLabel ? `${yLabel} by ${xLabel}` : `${xLabel} Distribution`;
      case 'pie':
        return `${xLabel} Distribution`;
      case 'histogram':
        return `Histogram of ${xLabel}`;
      case 'scatter':
        return `${yLabel} vs ${xLabel}`;
      default:
        return 'Data Visualization';
    }
  }
  
  // Load more data functionality
  $('#load-more-data').on('click', function() {
    const offset = $('#data-preview tbody tr').length;
    const button = $(this);
    
    button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');
    
    $.ajax({
      url: '{% url "load_more_data_view" dataset.id %}',
      type: 'GET',
      data: {
        offset: offset,
        limit: 10
      },
      success: function(response) {
        if (response.status === 'success') {
          // Append new rows
          const tbody = $('#data-preview tbody');
          
          response.data.forEach(function(row) {
            const tr = $('<tr>');
            row.forEach(function(cell) {
              tr.append($('<td>').text(cell));
            });
            tbody.append(tr);
          });
          
          button.prop('disabled', false).html('<i class="fas fa-sync"></i> Load More');
          
          // Hide button if all data loaded
          if (offset + response.data.length >= response.total) {
            button.hide();
          }
        } else {
          alert('Error loading more data: ' + response.message);
          button.prop('disabled', false).html('<i class="fas fa-sync"></i> Load More');
        }
      },
      error: function() {
        alert('Error communicating with server');
        button.prop('disabled', false).html('<i class="fas fa-sync"></i> Load More');
      }
    });
  });
  
  // Export CSV functionality
  $('#export-csv').on('click', function() {
    window.location.href = '{% url "export_csv_view" dataset.id %}';
  });
  
  // Generate insights functionality
  $('#generate-insights').on('click', function() {
    const button = $(this);
    const insightsContainer = $('#insights-container');
    const insightsLoading = $('#insights-loading');
    
    button.prop('disabled', true);
    insightsContainer.addClass('d-none');
    insightsLoading.removeClass('d-none');
    
    $.ajax({
      url: '{% url "generate_insights_view" dataset.id %}',
      type: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function(response) {
        if (response.status === 'success') {
          // Clear existing insights
          const insightsRow = $('#insights-row').empty();
          
          // Add new insights
          response.insights.forEach(function(insight, index) {
            const colorClasses = ['primary', 'success', 'info', 'warning', 'danger'];
            const colorClass = colorClasses[index % colorClasses.length];
            
            const insightCard = `
              <div class="col-md-4 mb-3">
                <div class="card h-100">
                  <div class="card-header bg-${colorClass} text-white">
                    <h6 class="mb-0">Insight ${index + 1}</h6>
                  </div>
                  <div class="card-body">
                    <p>${insight}</p>
                  </div>
                </div>
              </div>
            `;
            
            insightsRow.append(insightCard);
          });
          
          insightsLoading.addClass('d-none');
          insightsContainer.removeClass('d-none');
        } else {
          alert('Error generating insights: ' + response.message);
          insightsLoading.addClass('d-none');
        }
        
        button.prop('disabled', false);
      },
      error: function() {
        alert('Error communicating with server');
        insightsLoading.addClass('d-none');
        button.prop('disabled', false);
      }
    });
  });
  
  // Trigger insights generation on page load
  $('#generate-insights').trigger('click');
});
</script>
{% endblock %} 