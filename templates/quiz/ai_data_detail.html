{% extends 'quiz/adminbase.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ upload.original_filename }}</h1>
        <div>
            <a href="{% url 'ai_view_data_list' %}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
                <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Data Explorer
            </a>
            <a href="#" id="trainModelBtn" class="d-none d-sm-inline-block btn btn-sm btn-success shadow-sm ml-2">
                <i class="fas fa-brain fa-sm text-white-50"></i> Train Model
            </a>
            <a href="#" id="exportCSVBtn" class="d-none d-sm-inline-block btn btn-sm btn-info shadow-sm ml-2">
                <i class="fas fa-download fa-sm text-white-50"></i> Export Data
            </a>
        </div>
    </div>
    
    <!-- Upload Information -->
    <div class="row">
        <div class="col-xl-12 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Upload Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>File Name:</strong> {{ upload.original_filename }}</p>
                            <p><strong>Records:</strong> {{ total_records }}</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Upload Date:</strong> {{ upload.created_at|date:"M d, Y H:i" }}</p>
                            <p><strong>Status:</strong> <span class="badge badge-{% if upload.status == 'completed' %}success{% elif upload.status == 'failed' %}danger{% elif upload.status == 'processing' %}warning{% else %}info{% endif %}">{{ upload.status|title }}</span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Cleaned Data:</strong> {% if upload.cleaned_data %}<i class="fas fa-check-circle text-success"></i>{% else %}<i class="fas fa-times-circle text-danger"></i>{% endif %}</p>
                            <p><strong>Model Trained:</strong> {% if upload.model_trained %}<i class="fas fa-check-circle text-success"></i> ({{ upload.model_accuracy|floatformat:2 }}){% else %}<i class="fas fa-times-circle text-danger"></i>{% endif %}</p>
                        </div>
                        <div class="col-md-3 text-right">
                            <button class="btn btn-danger delete-upload" data-id="{{ upload.id }}" data-toggle="modal" data-target="#deleteModal">
                                <i class="fas fa-trash"></i> Delete Dataset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics and Data Sample -->
    <div class="row">
        <!-- Statistics -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Dataset Statistics</h6>
                </div>
                <div class="card-body">
                    <!-- Faculty Distribution -->
                    <div class="mb-4">
                        <h6 class="font-weight-bold">Faculty Distribution</h6>
                        <div class="chart-bar">
                            <canvas id="facultyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- AI Familiarity -->
                    <div class="mb-4">
                        <h6 class="font-weight-bold">AI Familiarity Levels</h6>
                        <div class="chart-pie">
                            <canvas id="familiarityChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top AI Tools -->
                    <div class="mb-4">
                        <h6 class="font-weight-bold">Top AI Tools Used</h6>
                        {% if top_tools %}
                        <div class="chart-bar">
                            <canvas id="toolsChart"></canvas>
                        </div>
                        {% else %}
                        <div class="alert alert-info">No tools data available</div>
                        {% endif %}
                    </div>
                    
                    <!-- Study Level Distribution -->
                    <div class="mb-4">
                        <h6 class="font-weight-bold">Study Level Distribution</h6>
                        <div class="chart-pie">
                            <canvas id="levelChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Sample -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Data Sample (First 10 Records)</h6>
                    <button class="btn btn-sm btn-primary" id="viewMoreData">View More</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Faculty</th>
                                    <th>Level</th>
                                    <th>AI Familiarity</th>
                                    <th>Uses AI Tools</th>
                                    <th>Tools Used</th>
                                    <th>Adoption Level</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in data_sample %}
                                <tr>
                                    <td>{{ item.faculty }}</td>
                                    <td>{{ item.level_of_study }}</td>
                                    <td>{{ item.ai_familiarity }}/5</td>
                                    <td>
                                        {% if item.uses_ai_tools == 'yes' %}
                                        <span class="badge badge-success">Yes</span>
                                        {% else %}
                                        <span class="badge badge-secondary">No</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.tools_used %}
                                        <span class="d-inline-block text-truncate" style="max-width: 150px;" title="{{ item.tools_used }}">
                                            {{ item.tools_used }}
                                        </span>
                                        {% else %}
                                        <em class="text-muted">None</em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.adoption_level == 'high' or item.adoption_level == 'very_high' %}
                                        <span class="badge badge-success">{{ item.adoption_level|title }}</span>
                                        {% elif item.adoption_level == 'medium' %}
                                        <span class="badge badge-warning">{{ item.adoption_level|title }}</span>
                                        {% else %}
                                        <span class="badge badge-danger">{{ item.adoption_level|title }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No data available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Insights -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Generated Insights</h6>
                </div>
                <div class="card-body">
                    {% if upload.insights %}
                    <div class="insights-container">
                        {% with insights_list=upload.insights|split:"|" %}
                            {% for insight in insights_list %}
                                <div class="alert alert-info">
                                    <i class="fas fa-lightbulb mr-2"></i> {{ insight }}
                                </div>
                            {% empty %}
                                <div class="alert alert-warning">No insights generated for this dataset.</div>
                            {% endfor %}
                        {% endwith %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle mr-2"></i> No insights available. 
                        <button class="btn btn-sm btn-primary ml-3" id="generateInsights">Generate Insights</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">Are you sure you want to delete this dataset? This will permanently remove all associated records and cannot be undone.</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                <a class="btn btn-danger" id="confirmDelete" href="#">Delete Dataset</a>
            </div>
        </div>
    </div>
</div>

<!-- Train Model Modal -->
<div class="modal fade" id="trainModelModal" tabindex="-1" role="dialog" aria-labelledby="trainModelModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trainModelModalLabel">Train AI Model</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="trainModelForm">
                    <div class="form-group">
                        <label for="algorithm">Algorithm</label>
                        <select class="form-control" id="algorithm" name="algorithm">
                            <option value="random_forest">Random Forest</option>
                            <option value="svm">Support Vector Machine</option>
                            <option value="logistic_regression">Logistic Regression</option>
                            <option value="neural_network">Neural Network</option>
                        </select>
                    </div>
                    <input type="hidden" name="csv_upload_id" value="{{ upload.id }}">
                </form>
                
                <div id="trainingProgress" class="d-none">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Training...</span>
                        </div>
                        <p class="mt-2" id="trainingStatus">Initializing training...</p>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" 
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="trainingProgressBar">
                        </div>
                    </div>
                </div>
                
                <div id="trainingResult" class="d-none">
                    <div class="alert alert-success">
                        <h5>Training Complete!</h5>
                        <p><strong>Accuracy:</strong> <span id="modelAccuracy">0.0</span></p>
                        <p><strong>Algorithm:</strong> <span id="modelAlgorithm">None</span></p>
                        <p><strong>Training Time:</strong> <span id="trainingTime">0</span> seconds</p>
                    </div>
                </div>
                
                <div id="trainingError" class="d-none">
                    <div class="alert alert-danger">
                        <h5>Training Failed</h5>
                        <p id="errorMessage">An error occurred during training.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal" id="cancelTraining">Cancel</button>
                <button class="btn btn-primary" type="button" id="startTraining">Start Training</button>
                <button class="btn btn-success d-none" type="button" data-dismiss="modal" id="finishTraining">Done</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block custom_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    $(document).ready(function() {
        // Charts initialization
        // Faculty Chart
        var facultyCtx = document.getElementById('facultyChart').getContext('2d');
        var facultyChart = new Chart(facultyCtx, {
            type: 'bar',
            data: {
                labels: [{% for f in faculties %}"{{ f.faculty }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Number of Records',
                    data: [{% for f in faculties %}{{ f.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: 'rgba(78, 115, 223, 0.8)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Familiarity Chart
        var familiarityCtx = document.getElementById('familiarityChart').getContext('2d');
        var familiarityData = {
            labels: ['1 (Low)', '2', '3', '4', '5 (High)'],
            datasets: [{
                data: [
                    {{ familiarity_counts.1|default:0 }},
                    {{ familiarity_counts.2|default:0 }},
                    {{ familiarity_counts.3|default:0 }},
                    {{ familiarity_counts.4|default:0 }},
                    {{ familiarity_counts.5|default:0 }}
                ],
                backgroundColor: [
                    'rgba(231, 74, 59, 0.7)',
                    'rgba(246, 194, 62, 0.7)',
                    'rgba(54, 185, 204, 0.7)',
                    'rgba(28, 200, 138, 0.7)',
                    'rgba(78, 115, 223, 0.7)'
                ],
                borderColor: [
                    'rgba(231, 74, 59, 1)',
                    'rgba(246, 194, 62, 1)',
                    'rgba(54, 185, 204, 1)',
                    'rgba(28, 200, 138, 1)',
                    'rgba(78, 115, 223, 1)'
                ],
                borderWidth: 1
            }]
        };
        
        var familiarityChart = new Chart(familiarityCtx, {
            type: 'pie',
            data: familiarityData,
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Tools Chart
        {% if top_tools %}
        var toolsCtx = document.getElementById('toolsChart').getContext('2d');
        var toolsChart = new Chart(toolsCtx, {
            type: 'horizontalBar',
            data: {
                labels: [{% for tool in top_tools %}"{{ tool.0 }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Usage Count',
                    data: [{% for tool in top_tools %}{{ tool.1 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: 'rgba(54, 185, 204, 0.7)',
                    borderColor: 'rgba(54, 185, 204, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });
        {% endif %}
        
        // Level Chart
        var levelCtx = document.getElementById('levelChart').getContext('2d');
        var levelChart = new Chart(levelCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for level in levels %}"{{ level.level_of_study }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for level in levels %}{{ level.count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: [
                        'rgba(78, 115, 223, 0.7)',
                        'rgba(28, 200, 138, 0.7)',
                        'rgba(246, 194, 62, 0.7)',
                        'rgba(54, 185, 204, 0.7)',
                        'rgba(231, 74, 59, 0.7)'
                    ],
                    borderColor: [
                        'rgba(78, 115, 223, 1)',
                        'rgba(28, 200, 138, 1)',
                        'rgba(246, 194, 62, 1)',
                        'rgba(54, 185, 204, 1)',
                        'rgba(231, 74, 59, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Handle delete confirmation
        $('.delete-upload').click(function() {
            var uploadId = $(this).data('id');
            $('#confirmDelete').attr('href', "{% url 'delete_upload_view' 0 %}".replace('0', uploadId));
        });
        
        // Handle training model
        $('#trainModelBtn').click(function(e) {
            e.preventDefault();
            $('#trainModelModal').modal('show');
        });
        
        $('#startTraining').click(function() {
            // Hide form, show progress
            $('#trainModelForm').hide();
            $('#trainingProgress').removeClass('d-none');
            $('#startTraining').addClass('d-none');
            $('#cancelTraining').addClass('d-none');
            
            // Setup progress animation
            var progress = 0;
            var interval = setInterval(function() {
                progress += 5;
                if (progress <= 90) {
                    $('#trainingProgressBar').css('width', progress + '%');
                    $('#trainingProgressBar').attr('aria-valuenow', progress);
                    
                    if (progress < 30) {
                        $('#trainingStatus').text('Preparing data...');
                    } else if (progress < 60) {
                        $('#trainingStatus').text('Training model...');
                    } else {
                        $('#trainingStatus').text('Evaluating model performance...');
                    }
                }
            }, 300);
            
            // Submit the training request
            $.ajax({
                url: "{% url 'train_model_view' %}",
                type: 'POST',
                data: $('#trainModelForm').serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    clearInterval(interval);
                    $('#trainingProgress').addClass('d-none');
                    
                    if (response.status === 'success') {
                        // Show success
                        $('#trainingResult').removeClass('d-none');
                        $('#modelAccuracy').text((response.accuracy * 100).toFixed(2) + '%');
                        $('#modelAlgorithm').text(response.algorithm);
                        $('#trainingTime').text(response.training_time.toFixed(2));
                        $('#trainingProgressBar').css('width', '100%');
                        $('#finishTraining').removeClass('d-none');
                        
                        // Confetti effect
                        if(response.accuracy > 0.7) {
                            throwConfetti();
                        }
                    } else {
                        // Show error
                        $('#trainingError').removeClass('d-none');
                        $('#errorMessage').text(response.message);
                        $('#cancelTraining').removeClass('d-none').text('Close');
                    }
                },
                error: function(xhr) {
                    clearInterval(interval);
                    $('#trainingProgress').addClass('d-none');
                    $('#trainingError').removeClass('d-none');
                    $('#errorMessage').text('Server error: ' + xhr.statusText);
                    $('#cancelTraining').removeClass('d-none').text('Close');
                }
            });
        });
        
        // Reset modal when closed
        $('#trainModelModal').on('hidden.bs.modal', function () {
            $('#trainModelForm').show();
            $('#trainingProgress').addClass('d-none');
            $('#trainingResult').addClass('d-none');
            $('#trainingError').addClass('d-none');
            $('#startTraining').removeClass('d-none');
            $('#cancelTraining').removeClass('d-none').text('Cancel');
            $('#finishTraining').addClass('d-none');
            $('#trainingProgressBar').css('width', '0%');
        });
        
        // Export CSV function
        $('#exportCSVBtn').click(function(e) {
            e.preventDefault();
            window.location.href = "{% url 'export_csv_view' upload.id %}";
        });
        
        // Generate insights function
        $('#generateInsights').click(function(e) {
            e.preventDefault();
            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...');
            
            $.ajax({
                url: "{% url 'generate_insights_view' upload.id %}",
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        // Refresh the page to show new insights
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                        $('#generateInsights').prop('disabled', false).text('Generate Insights');
                    }
                },
                error: function() {
                    alert('Server error occurred');
                    $('#generateInsights').prop('disabled', false).text('Generate Insights');
                }
            });
        });
        
        // Function to throw confetti
        function throwConfetti() {
            var canvas = document.createElement('canvas');
            canvas.id = 'confetti-canvas';
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.pointerEvents = 'none';
            canvas.style.zIndex = '9999';
            document.body.appendChild(canvas);
            
            var confetti = {
                maxCount: 150,
                speed: 2,
                frameInterval: 15,
                alpha: 1.0,
                gradient: false,
                particles: [],
                active: true,
                canvas: canvas,
                ctx: canvas.getContext('2d'),
                colors: [
                    [85, 71, 106],
                    [174, 61, 99],
                    [219, 56, 83],
                    [244, 92, 68],
                    [248, 182, 70]
                ],
                
                init: function() {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                    this.particles = [];
                    this.active = true;
                    
                    for (var i = 0; i < this.maxCount; i++) {
                        this.particles.push({
                            x: Math.random() * this.canvas.width,
                            y: Math.random() * -this.canvas.height,
                            r: Math.random() * 4 + 1,
                            d: Math.random() * this.maxCount,
                            color: this.colors[Math.floor(Math.random() * this.colors.length)],
                            tilt: Math.floor(Math.random() * 10) - 10,
                            tiltAngleIncremental: Math.random() * 0.07 + 0.05,
                            tiltAngle: 0
                        });
                    }
                    
                    this.run();
                },
                
                draw: function() {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    for (var i = 0; i < this.particles.length; i++) {
                        var p = this.particles[i];
                        this.ctx.beginPath();
                        this.ctx.lineWidth = p.r;
                        this.ctx.strokeStyle = "rgba(" + p.color[0] + "," + p.color[1] + "," + p.color[2] + "," + p.alpha + ")";
                        this.ctx.moveTo(p.x + p.tilt + (p.r / 4), p.y);
                        this.ctx.lineTo(p.x + p.tilt, p.y + p.tilt + (p.r / 4));
                        this.ctx.stroke();
                    }
                },
                
                update: function() {
                    var remainingFlakes = 0;
                    var particle;
                    
                    for (var i = 0; i < this.particles.length; i++) {
                        particle = this.particles[i];
                        particle.tiltAngle += particle.tiltAngleIncremental;
                        particle.y += (Math.cos(particle.d) + this.speed + particle.r / 2) / 2;
                        particle.x += Math.sin(particle.tiltAngle) * 2;
                        particle.tilt = Math.sin(particle.tiltAngle) * 15;
                        
                        if (particle.y < this.canvas.height) {
                            remainingFlakes++;
                        }
                    }
                    
                    if (remainingFlakes === 0) {
                        this.active = false;
                        document.body.removeChild(this.canvas);
                    }
                },
                
                run: function() {
                    var that = this;
                    
                    (function runAnimation() {
                        that.update();
                        that.draw();
                        
                        if (that.active) {
                            requestAnimFrame(runAnimation);
                        }
                    })();
                }
            };
            
            window.requestAnimFrame = (function() {
                return window.requestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    window.msRequestAnimationFrame ||
                    function(callback) {
                        return window.setTimeout(callback, 1000 / 60);
                    };
            })();
            
            confetti.init();
            
            // Remove confetti after 5 seconds if still active
            setTimeout(function() {
                if (confetti.active && document.getElementById('confetti-canvas')) {
                    confetti.active = false;
                    document.body.removeChild(canvas);
                }
            }, 5000);
        }
    });
</script>
{% endblock %} 